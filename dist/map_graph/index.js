var t={54:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var a='',n=void 0!==e[5];return e[4]&&(a+='@supports ('.concat(e[4],') {')),e[2]&&(a+='@media '.concat(e[2],' {')),n&&(a+='@layer'.concat(e[5].length>0?' '.concat(e[5]):'',' {')),a+=t(e),n&&(a+='}'),e[2]&&(a+='}'),e[4]&&(a+='}'),a}).join('')},e.i=function(t,a,n,i,s){'string'==typeof t&&(t=[[null,t,void 0]]);var o={};if(n)for(var r=0;r<this.length;r++){var c=this[r][0];null!=c&&(o[c]=!0)}for(var h=0;h<t.length;h++){var l=[].concat(t[h]);n&&o[l[0]]||(void 0!==s&&(void 0===l[5]||(l[1]='@layer'.concat(l[5].length>0?' '.concat(l[5]):'',' {').concat(l[1],'}')),l[5]=s),a&&(l[2]?(l[1]='@media '.concat(l[2],' {').concat(l[1],'}'),l[2]=a):l[2]=a),i&&(l[4]?(l[1]='@supports ('.concat(l[4],') {').concat(l[1],'}'),l[4]=i):l[4]=''.concat(i)),e.push(l))}},e}},119:(t,e,a)=>{a.r(e),a.d(e,{default:()=>r});var n=a(790),i=a.n(n),s=a(54),o=a.n(s)()(i());o.push([t.id,'.map_controls[data-v-2de7aaed]{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:8px;z-index:10}.map_controls .control_button[data-v-2de7aaed]{width:36px;height:36px;background:rgba(22,33,62,.9);border:1px solid #4a9eff;border-radius:6px;color:#4a9eff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s ease;-webkit-user-select:none;user-select:none}.map_controls .control_button[data-v-2de7aaed]:hover{background:rgba(74,158,255,.2);color:#e8eaf0;transform:scale(1.05)}.map_controls .control_button[data-v-2de7aaed]:active{transform:scale(0.95);background:rgba(74,158,255,.4)}.map_controls .control_button i[data-v-2de7aaed]{pointer-events:none}@media (max-width:768px){.map_controls[data-v-2de7aaed]{top:8px;right:8px;gap:6px}.map_controls .control_button[data-v-2de7aaed]{width:32px;height:32px;font-size:12px}.map_controls .control_button[data-v-2de7aaed]:active{transform:scale(0.9);background:rgba(74,158,255,.5)}}@media (max-width:480px){.map_controls[data-v-2de7aaed]{top:6px;right:6px;gap:4px}.map_controls .control_button[data-v-2de7aaed]{width:30px;height:30px;font-size:11px;border-radius:4px}.map_controls .control_button[data-v-2de7aaed]:active{transform:scale(0.85)}}','',{version:3,sources:['webpack://./src/map_graph/components/MapControls.vue'],names:[],mappings:'AACA,+BACE,iBAAA,CACA,QAAA,CACA,UAAA,CACA,YAAA,CACA,qBAAA,CACA,OAAA,CACA,UAAA,CAEA,+CACE,UAAA,CACA,WAAA,CACA,4BAAA,CACA,wBAAA,CACA,iBAAA,CACA,aAAA,CACA,cAAA,CACA,YAAA,CACA,kBAAA,CACA,sBAAA,CACA,cAAA,CACA,uBAAA,CACA,wBAAA,CAAA,gBAAA,CAEA,qDACE,8BAAA,CACA,aAAA,CACA,qBAAA,CAGF,sDACE,qBAAA,CACA,8BAAA,CAGF,iDACE,mBAAA,CAMN,yBACE,+BACE,OAAA,CACA,SAAA,CACA,OAAA,CAEA,+CACE,UAAA,CACA,WAAA,CACA,cAAA,CAEA,sDACE,oBAAA,CACA,8BAAA,CAAA,CAMR,yBACE,+BACE,OAAA,CACA,SAAA,CACA,OAAA,CAEA,+CACE,UAAA,CACA,WAAA,CACA,cAAA,CACA,iBAAA,CAEA,sDACE,qBAAA,CAAA',sourcesContent:['\n.map_controls {\n  position: absolute;\n  top: 10px;\n  right: 10px;\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  z-index: 10;\n\n  .control_button {\n    width: 36px;\n    height: 36px;\n    background: rgba(22, 33, 62, 0.9);\n    border: 1px solid #4a9eff;\n    border-radius: 6px;\n    color: #4a9eff;\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 14px;\n    transition: all 0.2s ease;\n    user-select: none;\n\n    &:hover {\n      background: rgba(74, 158, 255, 0.2);\n      color: #e8eaf0;\n      transform: scale(1.05);\n    }\n\n    &:active {\n      transform: scale(0.95);\n      background: rgba(74, 158, 255, 0.4);\n    }\n\n    i {\n      pointer-events: none;\n    }\n  }\n}\n\n/* 移动端优化 */\n@media (max-width: 768px) {\n  .map_controls {\n    top: 8px;\n    right: 8px;\n    gap: 6px;\n\n    .control_button {\n      width: 32px;\n      height: 32px;\n      font-size: 12px;\n\n      &:active {\n        transform: scale(0.9);\n        background: rgba(74, 158, 255, 0.5);\n      }\n    }\n  }\n}\n\n@media (max-width: 480px) {\n  .map_controls {\n    top: 6px;\n    right: 6px;\n    gap: 4px;\n\n    .control_button {\n      width: 30px;\n      height: 30px;\n      font-size: 11px;\n      border-radius: 4px;\n\n      &:active {\n        transform: scale(0.85);\n      }\n    }\n  }\n}\n'],sourceRoot:''}]);const r=o},229:(t,e,a)=>{var n=a(119);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[t.id,n,'']]),n.locals&&(t.exports=n.locals);(0,a(424).A)('33fc2d9e',n,!1,{ssrId:!0})},374:(t,e,a)=>{var n=a(956);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[t.id,n,'']]),n.locals&&(t.exports=n.locals);(0,a(424).A)('2f85e7aa',n,!1,{ssrId:!0})},424:(t,e,a)=>{function n(t,e){for(var a=[],n={},i=0;i<e.length;i++){var s=e[i],o=s[0],r={id:t+':'+i,css:s[1],media:s[2],sourceMap:s[3]};n[o]?n[o].parts.push(r):a.push(n[o]={id:o,parts:[r]})}return a}a.d(e,{A:()=>m});var i='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!i)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var s={},o=i&&(document.head||document.getElementsByTagName('head')[0]),r=null,c=0,h=!1,l=function(){},d=null,A='data-vue-ssr-id',p='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function m(t,e,a,i){h=a,d=i||{};var o=n(t,e);return u(o),function(e){for(var a=[],i=0;i<o.length;i++){var r=o[i];(c=s[r.id]).refs--,a.push(c)}e?u(o=n(t,e)):o=[];for(i=0;i<a.length;i++){var c;if(0===(c=a[i]).refs){for(var h=0;h<c.parts.length;h++)c.parts[h]();delete s[c.id]}}}}function u(t){for(var e=0;e<t.length;e++){var a=t[e],n=s[a.id];if(n){n.refs++;for(var i=0;i<n.parts.length;i++)n.parts[i](a.parts[i]);for(;i<a.parts.length;i++)n.parts.push(g(a.parts[i]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var o=[];for(i=0;i<a.parts.length;i++)o.push(g(a.parts[i]));s[a.id]={id:a.id,refs:1,parts:o}}}}function f(){var t=document.createElement('style');return t.type='text/css',o.appendChild(t),t}function g(t){var e,a,n=document.querySelector('style['+A+'~="'+t.id+'"]');if(n){if(h)return l;n.parentNode.removeChild(n)}if(p){var i=c++;n=r||(r=f()),e=C.bind(null,n,i,!1),a=C.bind(null,n,i,!0)}else n=f(),e=b.bind(null,n),a=function(){n.parentNode.removeChild(n)};return e(t),function(n){if(n){if(n.css===t.css&&n.media===t.media&&n.sourceMap===t.sourceMap)return;e(t=n)}else a()}}var x,v=(x=[],function(t,e){return x[t]=e,x.filter(Boolean).join('\n')});function C(t,e,a,n){var i=a?'':n.css;if(t.styleSheet)t.styleSheet.cssText=v(e,i);else{var s=document.createTextNode(i),o=t.childNodes;o[e]&&t.removeChild(o[e]),o.length?t.insertBefore(s,o[e]):t.appendChild(s)}}function b(t,e){var a=e.css,n=e.media,i=e.sourceMap;if(n&&t.setAttribute('media',n),d.ssrId&&t.setAttribute(A,e.id),i&&(a+='\n/*# sourceURL='+i.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(i))))+' */'),t.styleSheet)t.styleSheet.cssText=a;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(a))}}},441:(t,e)=>{e.A=(t,e)=>{const a=t.__vccOpts||t;for(const[t,n]of e)a[t]=n;return a}},790:t=>{t.exports=function(t){var e=t[1],a=t[3];if(!a)return e;if('function'==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),i='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(n),s='/*# '.concat(i,' */');return[e].concat([s]).join('\n')}return[e].join('\n')}},956:(t,e,a)=>{a.r(e),a.d(e,{default:()=>r});var n=a(790),i=a.n(n),s=a(54),o=a.n(s)()(i());o.push([t.id,'.map_graph[data-v-ca1729aa]{font-family:"Segoe UI","Tahoma","Geneva","Verdana",sans-serif;color:rgba(232,234,240,.8);margin:15px 0;position:relative;z-index:1}.map_graph .map_container[data-v-ca1729aa]{background-color:#16213e;padding:6px;border-radius:6px;display:flex;flex-direction:column;gap:6px;border:1px solid #e8eaf0;position:relative;overflow:hidden}.map_graph .map_title_bar[data-v-ca1729aa]{text-align:center}.map_graph .map_title_bar .map_title[data-v-ca1729aa]{color:#e8eaf0;font-size:1.1rem;margin:0;text-transform:uppercase;letter-spacing:1px}.map_graph .map_title_bar i[data-v-ca1729aa]{color:#4a9eff;margin-right:8px}.map_graph .monitor-screen[data-v-ca1729aa]{background-color:rgba(22,33,62,.5);border:1px solid #8baac7;padding:5px;box-shadow:0 0 20px rgba(74,158,255,.2) inset;position:relative;overflow:hidden;width:100%;min-height:600px;cursor:grab;border-radius:4px;touch-action:pan-x pan-y}.map_graph .monitor-screen.grabbing[data-v-ca1729aa]{cursor:grabbing !important}.map_graph .monitor-screen canvas[data-v-ca1729aa]{position:absolute;top:0;left:0;width:100%;height:100%;display:block;background-color:rgba(0,0,0,0)}.map_graph .monitor-screen .zoom_indicator[data-v-ca1729aa]{position:absolute;top:10px;left:10px;background:rgba(22,33,62,.9);border:1px solid #4a9eff;border-radius:6px;padding:8px 12px;color:#e8eaf0;font-size:14px;font-weight:bold;z-index:10;opacity:.9;transition:opacity .3s ease;-webkit-user-select:none;user-select:none;pointer-events:none}@media (max-width:768px){.map_graph[data-v-ca1729aa]{margin:10px 0}.map_graph .map_container[data-v-ca1729aa]{padding:8px 4px 4px 4px}.map_graph .monitor-screen[data-v-ca1729aa]{min-height:400px;padding:3px;touch-action:manipulation}.map_graph .monitor-screen .zoom_indicator[data-v-ca1729aa]{top:8px;left:8px;padding:6px 10px;font-size:12px}.map_graph .map_title_bar .map_title[data-v-ca1729aa]{font-size:1.1rem}.map_graph .map_title_bar .map_movement[data-v-ca1729aa]{font-size:.9rem}}@media (max-width:480px){.map_graph .monitor-screen[data-v-ca1729aa]{min-height:300px}.map_graph .monitor-screen .zoom_indicator[data-v-ca1729aa]{top:6px;left:6px;padding:4px 8px;font-size:11px;border-radius:4px}.map_graph .map_title_bar .map_title[data-v-ca1729aa]{font-size:1rem}}','',{version:3,sources:['webpack://./src/map_graph/components/MapContainer.vue'],names:[],mappings:'AACA,4BACE,6DAAA,CACA,0BAAA,CACA,aAAA,CACA,iBAAA,CACA,SAAA,CAEA,2CACE,wBAAA,CACA,WAAA,CACA,iBAAA,CACA,YAAA,CACA,qBAAA,CACA,OAAA,CACA,wBAAA,CACA,iBAAA,CACA,eAAA,CAGF,2CACE,iBAAA,CAEA,sDACE,aAAA,CACA,gBAAA,CACA,QAAA,CACA,wBAAA,CACA,kBAAA,CAGF,6CACE,aAAA,CACA,gBAAA,CAIJ,4CACE,kCAAA,CACA,wBAAA,CACA,WAAA,CACA,6CAAA,CACA,iBAAA,CACA,eAAA,CACA,UAAA,CACA,gBAAA,CACA,WAAA,CACA,iBAAA,CAEA,wBAAA,CAEA,qDACE,0BAAA,CAGF,mDACE,iBAAA,CACA,KAAA,CACA,MAAA,CACA,UAAA,CACA,WAAA,CACA,aAAA,CACA,8BAAA,CAGF,4DACE,iBAAA,CACA,QAAA,CACA,SAAA,CACA,4BAAA,CACA,wBAAA,CACA,iBAAA,CACA,gBAAA,CACA,aAAA,CACA,cAAA,CACA,gBAAA,CACA,UAAA,CACA,UAAA,CACA,2BAAA,CACA,wBAAA,CAAA,gBAAA,CACA,mBAAA,CAMN,yBACE,4BACE,aAAA,CAEA,2CACE,uBAAA,CAGF,4CACE,gBAAA,CACA,WAAA,CAEA,yBAAA,CAEA,4DACE,OAAA,CACA,QAAA,CACA,gBAAA,CACA,cAAA,CAKF,sDACE,gBAAA,CAGF,yDACE,eAAA,CAAA,CAOR,yBAEI,4CACE,gBAAA,CAEA,4DACE,OAAA,CACA,QAAA,CACA,eAAA,CACA,cAAA,CACA,iBAAA,CAKF,sDACE,cAAA,CAAA',sourcesContent:['\n.map_graph {\n  font-family: \'Segoe UI\', \'Tahoma\', \'Geneva\', \'Verdana\', sans-serif;\n  color: rgba(232, 234, 240, 0.8);\n  margin: 15px 0;\n  position: relative;\n  z-index: 1;\n\n  .map_container {\n    background-color: #16213e;\n    padding: 6px;\n    border-radius: 6px;\n    display: flex;\n    flex-direction: column;\n    gap: 6px;\n    border: 1px solid #e8eaf0;\n    position: relative;\n    overflow: hidden;\n  }\n\n  .map_title_bar {\n    text-align: center;\n\n    .map_title {\n      color: #e8eaf0;\n      font-size: 1.1rem;\n      margin: 0;\n      text-transform: uppercase;\n      letter-spacing: 1px;\n    }\n\n    i {\n      color: #4a9eff;\n      margin-right: 8px;\n    }\n  }\n\n  .monitor-screen {\n    background-color: rgba(22, 33, 62, 0.5);\n    border: 1px solid #8baac7;\n    padding: 5px;\n    box-shadow: 0 0 20px rgba(74, 158, 255, 0.2) inset;\n    position: relative;\n    overflow: hidden;\n    width: 100%;\n    min-height: 600px;\n    cursor: grab;\n    border-radius: 4px;\n    // 确保在移动端的稳定性\n    touch-action: pan-x pan-y;\n\n    &.grabbing {\n      cursor: grabbing !important;\n    }\n\n    canvas {\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      display: block;\n      background-color: transparent;\n    }\n\n    .zoom_indicator {\n      position: absolute;\n      top: 10px;\n      left: 10px;\n      background: rgba(22, 33, 62, 0.9);\n      border: 1px solid #4a9eff;\n      border-radius: 6px;\n      padding: 8px 12px;\n      color: #e8eaf0;\n      font-size: 14px;\n      font-weight: bold;\n      z-index: 10;\n      opacity: 0.9;\n      transition: opacity 0.3s ease;\n      user-select: none;\n      pointer-events: none;\n    }\n  }\n}\n\n/* 响应式设计 */\n@media (max-width: 768px) {\n  .map_graph {\n    margin: 10px 0;\n\n    .map_container {\n      padding: 8px 4px 4px 4px;\n    }\n\n    .monitor-screen {\n      min-height: 400px;\n      padding: 3px;\n      // 优化触摸体验\n      touch-action: manipulation;\n\n      .zoom_indicator {\n        top: 8px;\n        left: 8px;\n        padding: 6px 10px;\n        font-size: 12px;\n      }\n    }\n\n    .map_title_bar {\n      .map_title {\n        font-size: 1.1rem;\n      }\n\n      .map_movement {\n        font-size: 0.9rem;\n      }\n    }\n  }\n}\n\n// 针对更小屏幕的优化\n@media (max-width: 480px) {\n  .map_graph {\n    .monitor-screen {\n      min-height: 300px;\n\n      .zoom_indicator {\n        top: 6px;\n        left: 6px;\n        padding: 4px 8px;\n        font-size: 11px;\n        border-radius: 4px;\n      }\n    }\n\n    .map_title_bar {\n      .map_title {\n        font-size: 1rem;\n      }\n    }\n  }\n}\n'],sourceRoot:''}]);const r=o}},e={};function a(n){var i=e[n];if(void 0!==i)return i.exports;var s=e[n]={id:n,exports:{}};return t[n](s,s.exports,a),s.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(t,'__esModule',{value:!0})};const n=Vue;class i{canvas;ctx;viewState;mapData=null;get isMobile(){return window.innerWidth<=768}get isSmallMobile(){return window.innerWidth<=480}constructor(t){this.canvas=t;const e=t.getContext('2d');if(!e)throw new Error('无法获取Canvas上下文');this.ctx=e,this.viewState={offsetX:0,offsetY:0,scale:1},this.setupCanvas()}setupCanvas(){this.updateCanvasSize(),this.optimizeCanvasQuality()}optimizeCanvasQuality(){this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality='high',this.ctx.lineCap='round',this.ctx.lineJoin='round'}updateCanvasSize(){const t=window.devicePixelRatio||1,e=this.canvas.getBoundingClientRect(),a=e.width*t,n=e.height*t;this.canvas.width===a&&this.canvas.height===n||(this.canvas.width=a,this.canvas.height=n,this.canvas.style.width=e.width+'px',this.canvas.style.height=e.height+'px',this.ctx.setTransform(1,0,0,1,0,0),this.optimizeCanvasQuality())}setMapData(t){this.mapData=t,setTimeout(()=>{this.resetView(),this.render()},50)}resetView(){if(!this.mapData||0===this.mapData.nodes.length)return;this.updateCanvasSize();const t=this.mapData.nodes.map(t=>t.x),e=this.mapData.nodes.map(t=>t.y),a=Math.min(...t),n=Math.max(...t),i=Math.min(...e),s=Math.max(...e),o=n-a,r=s-i,c=this.canvas.getBoundingClientRect(),h=c.width,l=c.height;if(0===o&&0===r)return this.viewState.offsetX=-(a+n)/2,this.viewState.offsetY=-(i+s)/2,void(this.viewState.scale=1);let d=1;if(h>0&&l>0){const t=o>0?.8*h/o:1,e=r>0?.8*l/r:1;d=Math.min(t,e),d=Math.min(Math.max(d,.2),2)}this.viewState.offsetX=-(a+n)/2,this.viewState.offsetY=-(i+s)/2,this.viewState.scale=d}render(){this.mapData&&(this.updateCanvasSize(),this.clearCanvas(),this.applyTransform(),this.drawEdges(),this.drawNodes(),this.drawLabels())}clearCanvas(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.optimizeCanvasQuality()}applyTransform(){const{offsetX:t,offsetY:e,scale:a}=this.viewState,n=window.devicePixelRatio||1,i=this.canvas.width/2,s=this.canvas.height/2,o=a*n;this.ctx.setTransform(o,0,0,o,i+o*t,s+o*e),this.optimizeCanvasQuality()}drawEdges(){this.mapData&&this.mapData.edges.forEach(t=>{const e=this.mapData.nodes.find(e=>e.id===t.from),a=this.mapData.nodes.find(e=>e.id===t.to);if(e&&a){const n=this.getNodeEdgePoint(e,a),i=this.getNodeEdgePoint(a,e);this.drawEdge(t,n,i)}})}drawEdge(t,e,a){const n=this.isSmallMobile?.5:this.isMobile?.6:1;this.ctx.lineWidth=Math.max(.3,n/this.viewState.scale);const i='c'===t.type&&this.isEdgeConnectedToUnreachableNode(t),s=this.isSmallMobile?.6:this.isMobile?.7:Math.max(.8,1/this.viewState.scale);switch(t.type){case'l':this.ctx.strokeStyle='#ef4444',this.ctx.setLineDash([3*s,3*s]);break;case'ld':this.ctx.strokeStyle='#fbbf24',this.ctx.setLineDash([5*s,2*s]);break;case'lg':this.ctx.strokeStyle='#8b5cf6',this.ctx.setLineDash([6*s,1*s,1*s,1*s]);break;case'lb':this.ctx.strokeStyle='#ec4899',this.ctx.setLineDash([2*s,2*s]);break;case'lh':this.ctx.strokeStyle='#d1d5db',this.ctx.setLineDash([.8*s,2.5*s]);break;default:this.ctx.strokeStyle=i?'#6b7280':'#4a9eff',this.ctx.setLineDash([])}this.ctx.save();const o=(this.isSmallMobile?2:this.isMobile?3:4)/this.viewState.scale;this.ctx.shadowColor=this.ctx.strokeStyle,this.ctx.shadowBlur=o,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(a.x,a.y),this.ctx.stroke(),this.ctx.restore(),this.ctx.setLineDash([])}isEdgeConnectedToUnreachableNode(t){if(!this.mapData?.currentLocation)return!1;const e=this.mapData.nodes.find(e=>e.id===t.from),a=this.mapData.nodes.find(e=>e.id===t.to);return!(!e||!a)&&(e.id!==this.mapData.currentLocation&&a.id!==this.mapData.currentLocation&&(!this.isNodeReachable(e)||!this.isNodeReachable(a)))}getNodeEdgePoint(t,e){const a=e.x-t.x,n=e.y-t.y,i=Math.sqrt(a*a+n*n);if(0===i)return{x:t.x,y:t.y};const s=a/i,o=n/i;if('r'===t.shape){const e=(t.width||40)/2,a=(t.height||30)/2,n=[-a/o,a/o,-e/s,e/s].filter(t=>t>0),i=Math.min(...n);return{x:t.x+s*i,y:t.y+o*i}}{const e=t.radius||15;return{x:t.x+s*e,y:t.y+o*e}}}drawNodes(){this.mapData&&this.mapData.nodes.forEach(t=>{const e=t.id===this.mapData.currentLocation,a='e'===t.type,n=this.isNodeReachable(t);let i,s,o;e?(i='#14b8a6',s='#14b8a640',o='#14b8a6'):n?a?(i='#22c55e',s='#22c55e40',o='#22c55e'):(i='#4a9eff',s='#4a9eff40',o='#4a9eff'):(i='#6b7280',s='#6b728040',o='#6b7280');const r=this.isSmallMobile?.8:this.isMobile?1:1.2;this.ctx.lineWidth=Math.max(.4,r/this.viewState.scale);const c=(this.isSmallMobile?4:this.isMobile?5:6)/this.viewState.scale;if(this.ctx.save(),this.ctx.shadowColor=o,this.ctx.shadowBlur=c,this.ctx.strokeStyle=i,this.ctx.fillStyle=s,this.ctx.beginPath(),'r'===t.shape){const e=t.width||40,a=t.height||30;this.ctx.rect(t.x-e/2,t.y-a/2,e,a)}else{const e=t.radius||15;this.ctx.arc(t.x,t.y,e,0,2*Math.PI)}this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),a&&this.drawExitIcon(t)})}isNodeReachable(t){if(!this.mapData?.currentLocation)return!0;if(!this.mapData.nodes.find(t=>t.id===this.mapData.currentLocation))return!0;if('F'===this.mapData.free_movement)return!0;if('N'===this.mapData.free_movement)return t.id===this.mapData.currentLocation;return this.mapData.edges.filter(t=>(t.from===this.mapData.currentLocation||t.to===this.mapData.currentLocation)&&'c'===t.type).some(e=>(e.from===this.mapData.currentLocation?e.to:e.from)===t.id)}drawExitIcon(t){const e=(this.isMobile?8:12)/this.viewState.scale,a=t.y+('r'===t.shape?(t.height||30)/2:t.radius||15)+e+6/this.viewState.scale;this.ctx.font=`bold ${e}px "Segoe UI", sans-serif`;const n=this.ctx.measureText('EXIT').width,i=e,s=2/this.viewState.scale,o=t.x-n/2-s,r=a-i/2-1/this.viewState.scale,c=n+2*s,h=i+2/this.viewState.scale,l=2/this.viewState.scale;this.ctx.fillStyle='#22c55e',this.ctx.beginPath(),this.ctx.roundRect(o,r,c,h,l),this.ctx.fill(),this.ctx.fillStyle='#ffffff',this.ctx.textAlign='center',this.ctx.textBaseline='middle',this.ctx.fillText('EXIT',t.x,a)}drawLabels(){if(!this.mapData)return;this.ctx.textAlign='center',this.ctx.textBaseline='middle';const t=(this.isMobile?12:14)/this.viewState.scale;this.ctx.font=`${t}px "Segoe UI", sans-serif`,this.mapData.nodes.forEach(e=>{const a=e.id===this.mapData.currentLocation;if(this.ctx.fillStyle=a?'#14b8a6':'#e8eaf0',e.label&&this.ctx.fillText(e.label,e.x,e.y),a){this.ctx.fillStyle='#14b8a6',this.ctx.font=`bold ${.8*t}px "Segoe UI", sans-serif`,this.ctx.textBaseline='top';const a=e.y+('r'===e.shape?(e.height||30)/2:e.radius||15)+8/this.viewState.scale;this.ctx.fillText('[当前位置]',e.x,a),this.ctx.font=`${t}px "Segoe UI", sans-serif`,this.ctx.textBaseline='middle'}}),this.drawEdgeTypeInfo()}drawEdgeTypeInfo(){if(!this.mapData)return;const t=new Set(this.mapData.edges.map(t=>t.type)),e=[];if(t.has('c')&&e.push({type:'c',color:'#4a9eff',text:'普通路径',pattern:'────'}),t.has('l')&&e.push({type:'l',color:'#ef4444',text:'锁定路径',pattern:'- - -'}),t.has('ld')&&e.push({type:'ld',color:'#fbbf24',text:'门锁',pattern:'– – –'}),t.has('lg')&&e.push({type:'lg',color:'#8b5cf6',text:'守卫',pattern:'‒ ‒ ‒'}),t.has('lb')&&e.push({type:'lb',color:'#ec4899',text:'障碍',pattern:'··· ···'}),t.has('lh')&&e.push({type:'lh',color:'#d1d5db',text:'隐藏',pattern:'. . . .'}),0===e.length)return;this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0);const a=this.isSmallMobile?8:this.isMobile?10:12,n=this.isSmallMobile?18:this.isMobile?17:14,i=this.isSmallMobile?16:this.isMobile?14:10,s=this.isSmallMobile?30:this.isMobile?28:20,o=this.isSmallMobile?120:this.isMobile?110:90,r=this.canvas.height-a-e.length*n;this.ctx.fillStyle='rgba(22, 33, 62, 0.3)',this.ctx.fillRect(a-6,r-10,o,e.length*n+16),this.ctx.font=`${i}px "Segoe UI", sans-serif`,this.ctx.textAlign='left',this.ctx.textBaseline='top',e.forEach((t,e)=>{const i=r+e*n;this.ctx.strokeStyle=t.color,this.ctx.lineWidth=this.isSmallMobile?1.2:this.isMobile?1.4:1.5,this.ctx.lineCap='round',this.ctx.lineJoin='round';switch(t.type){case'l':this.ctx.setLineDash([3,3]);break;case'ld':this.ctx.setLineDash([5,2]);break;case'lg':this.ctx.setLineDash([6,1,1,1]);break;case'lb':this.ctx.setLineDash([2,2]);break;case'lh':this.ctx.setLineDash([.8,2.5]);break;default:this.ctx.setLineDash([])}this.ctx.save(),this.ctx.shadowColor=t.color,this.ctx.shadowBlur=3,this.ctx.beginPath(),this.ctx.moveTo(a,i+n/2),this.ctx.lineTo(a+s,i+n/2),this.ctx.stroke(),this.ctx.restore(),this.ctx.setLineDash([]),this.ctx.fillStyle='#e8eaf0',this.ctx.fillText(t.text,a+s+8,i+2)}),this.ctx.restore()}getViewState(){return{...this.viewState}}setViewState(t){Object.assign(this.viewState,t),this.render()}resetToFit(){this.resetView(),this.render()}getMapBounds(){if(!this.mapData||0===this.mapData.nodes.length)return null;const t=this.mapData.nodes.map(t=>t.x),e=this.mapData.nodes.map(t=>t.y);return{minX:Math.min(...t),maxX:Math.max(...t),minY:Math.min(...e),maxY:Math.max(...e)}}cleanup(){this.mapData=null}}class s{canvas;renderer;interactionState;config={minScale:.1,maxScale:5,zoomSensitivity:.001,touchZoomSensitivity:.005,panSensitivity:1};constructor(t,e){this.canvas=t,this.renderer=e,this.interactionState={isDragging:!1,lastPointerX:0,lastPointerY:0,lastScale:1},this.setupInteractions()}setupInteractions(){this.canvas.addEventListener('wheel',this.handleWheel.bind(this)),this.canvas.addEventListener('mousedown',this.handlePointerStart.bind(this)),this.canvas.addEventListener('mousemove',this.handlePointerMove.bind(this)),this.canvas.addEventListener('mouseup',this.handlePointerEnd.bind(this)),this.canvas.addEventListener('mouseleave',this.handlePointerEnd.bind(this)),this.canvas.addEventListener('touchstart',this.handleTouchStart.bind(this),{passive:!1}),this.canvas.addEventListener('touchmove',this.handleTouchMove.bind(this),{passive:!1}),this.canvas.addEventListener('touchend',this.handleTouchEnd.bind(this),{passive:!1}),this.canvas.addEventListener('contextmenu',t=>t.preventDefault())}handleWheel(t){t.preventDefault();const e=this.canvas.getBoundingClientRect(),a=t.clientX-e.left,n=t.clientY-e.top;this.zoomAt(a,n,-t.deltaY*this.config.zoomSensitivity)}handlePointerStart(t){0===t.button&&(this.startDrag(t.clientX,t.clientY),this.canvas.style.cursor='grabbing')}handlePointerMove(t){this.interactionState.isDragging&&this.updateDrag(t.clientX,t.clientY)}handlePointerEnd(){this.endDrag(),this.canvas.style.cursor='grab'}handleTouchStart(t){if(t.preventDefault(),1===t.touches.length){const e=t.touches[0];this.startDrag(e.clientX,e.clientY)}else if(2===t.touches.length){const e=t.touches[0],a=t.touches[1],n=this.getTouchDistance(e,a);this.interactionState.startPinchDistance=n,this.interactionState.lastScale=this.renderer.getViewState().scale,this.interactionState.isDragging=!1}}handleTouchMove(t){if(t.preventDefault(),1===t.touches.length&&this.interactionState.isDragging){const e=t.touches[0];this.updateDrag(e.clientX,e.clientY)}else if(2===t.touches.length&&this.interactionState.startPinchDistance){const e=t.touches[0],a=t.touches[1],n=(this.getTouchDistance(e,a)-this.interactionState.startPinchDistance)*this.config.touchZoomSensitivity,i=Math.max(this.config.minScale,Math.min(this.config.maxScale,this.interactionState.lastScale+n)),s=(e.clientX+a.clientX)/2,o=(e.clientY+a.clientY)/2,r=this.canvas.getBoundingClientRect();this.zoomAt(s-r.left,o-r.top,i,!1)}}handleTouchEnd(t){if(t.preventDefault(),0===t.touches.length)this.endDrag(),this.interactionState.startPinchDistance=void 0;else if(1===t.touches.length){this.interactionState.startPinchDistance=void 0;const e=t.touches[0];this.startDrag(e.clientX,e.clientY)}}startDrag(t,e){this.interactionState.isDragging=!0,this.interactionState.lastPointerX=t,this.interactionState.lastPointerY=e}updateDrag(t,e){if(!this.interactionState.isDragging)return;const a=t-this.interactionState.lastPointerX,n=e-this.interactionState.lastPointerY,i=this.renderer.getViewState(),s=i.offsetX+a/i.scale*this.config.panSensitivity,o=i.offsetY+n/i.scale*this.config.panSensitivity;this.renderer.setViewState({offsetX:s,offsetY:o}),this.interactionState.lastPointerX=t,this.interactionState.lastPointerY=e}endDrag(){this.interactionState.isDragging=!1}zoomAt(t,e,a,n=!0){const i=this.renderer.getViewState(),s=i.scale,o=n?Math.max(this.config.minScale,Math.min(this.config.maxScale,s+a)):Math.max(this.config.minScale,Math.min(this.config.maxScale,a));if(o===s)return;const r=this.canvas.getBoundingClientRect(),c=(t-r.width/2)/s-i.offsetX,h=(e-r.height/2)/s-i.offsetY,l=(t-r.width/2)/o-c,d=(e-r.height/2)/o-h;this.renderer.setViewState({scale:o,offsetX:l,offsetY:d})}getTouchDistance(t,e){const a=t.clientX-e.clientX,n=t.clientY-e.clientY;return Math.sqrt(a*a+n*n)}zoomIn(){const t=this.renderer.getViewState(),e=Math.min(this.config.maxScale,1.2*t.scale);this.renderer.setViewState({scale:e})}zoomOut(){const t=this.renderer.getViewState(),e=Math.max(this.config.minScale,t.scale/1.2);this.renderer.setViewState({scale:e})}setScale(t){const e=Math.max(this.config.minScale,Math.min(this.config.maxScale,t));this.renderer.setViewState({scale:e})}resetView(t){if(t){const e=t.maxX-t.minX,a=t.maxY-t.minY,n=this.canvas.getBoundingClientRect();if(0===e&&0===a)this.renderer.setViewState({offsetX:-(t.minX+t.maxX)/2,offsetY:-(t.minY+t.maxY)/2,scale:1});else{let i=1;if(n.width>0&&n.height>0){const t=e>0?.8*n.width/e:1,s=a>0?.8*n.height/a:1;i=Math.min(t,s),i=Math.min(Math.max(i,this.config.minScale),this.config.maxScale)}this.renderer.setViewState({offsetX:-(t.minX+t.maxX)/2,offsetY:-(t.minY+t.maxY)/2,scale:i})}}else this.renderer.setViewState({offsetX:0,offsetY:0,scale:1})}getInteractionState(){return{...this.interactionState}}cleanup(){this.canvas.removeEventListener('wheel',this.handleWheel.bind(this)),this.canvas.removeEventListener('mousedown',this.handlePointerStart.bind(this)),this.canvas.removeEventListener('mousemove',this.handlePointerMove.bind(this)),this.canvas.removeEventListener('mouseup',this.handlePointerEnd.bind(this)),this.canvas.removeEventListener('mouseleave',this.handlePointerEnd.bind(this)),this.canvas.removeEventListener('touchstart',this.handleTouchStart.bind(this)),this.canvas.removeEventListener('touchmove',this.handleTouchMove.bind(this)),this.canvas.removeEventListener('touchend',this.handleTouchEnd.bind(this)),this.canvas.removeEventListener('contextmenu',t=>t.preventDefault())}}class o{static MAP_REGEX=/<MapGraph>(.*?)<\/MapGraph>/s;static LOOSE_MAP_REGEX=/<\s*MapGraph\s*>([\s\S]*?)<\s*\/\s*MapGraph\s*>/i;static extractMapFromText(t){const e=this.MAP_REGEX.exec(t)||this.LOOSE_MAP_REGEX.exec(t);return e?e[1]:null}static parseMapData(t){const e=t.split('\n'),a={nodes:[],edges:[],metadata:{},currentLocation:null,free_movement:'A'},n=new Set;e.forEach(t=>{const e=t.trim();if(!e||e.startsWith('#'))return;const i=/^n:([^|]+)\|([^|]+)\|([^|@]+)(?:@([^|]*))?(?:\|)(\d+)\|(\d+)\|([rc])\|(.*)$/i.exec(e);if(i){const t=this.parseNode(i);return void(t&&!n.has(t.id)&&(n.add(t.id),a.nodes.push(t),(t.characters.includes('current')||t.characters.includes(''))&&(a.currentLocation=t.id)))}const s=/^e:([^|]+)\|([^|]+)(?:\|([^|]+))?$/i.exec(e);if(s){const t=this.parseEdge(s);return void(t&&a.edges.push(t))}const o=/^m:([^=]+)=(.*)$/i.exec(e);o&&this.parseMetadata(o,a)});const i=new Set(a.nodes.map(t=>t.id));return a.edges=a.edges.filter(t=>i.has(t.from)&&i.has(t.to)),a}static parseNode(t){const[,e,a,n,i,s,o,r,c]=t,h=parseInt(s,10),l=parseInt(o,10);if(isNaN(h)||isNaN(l))return null;const d={id:e.trim(),type:a.trim(),label:n.trim(),x:h,y:l,shape:r.toLowerCase().trim(),characters:i?i.split(',').map(t=>t.trim()).filter(Boolean):[]};if('r'===d.shape){const t=/^(\d+)x(\d+)$/i.exec(c);t?(d.width=parseInt(t[1],10),d.height=parseInt(t[2],10)):(d.width=40,d.height=30)}else if('c'===d.shape){const t=parseInt(c,10);d.radius=isNaN(t)?15:t}return d}static parseEdge(t){const[,e,a,n]=t;return{from:e.trim(),to:a.trim(),type:n?n.trim():'c'}}static parseMetadata(t,e){const[,a,n]=t,i=a.trim().toLowerCase();if('fm'===i){const t=n.trim().toUpperCase();['F','A','N'].includes(t)&&(e.free_movement=t)}else'desc'===i?e.metadata.description=n.trim():e.metadata[i]=n.trim()}}const r={class:'map_controls'},c=(0,n.defineComponent)({__name:'MapControls',emits:['zoom-in','zoom-out','reset-view'],setup:t=>(t,e)=>((0,n.openBlock)(),(0,n.createElementBlock)('div',r,[(0,n.createElementVNode)('button',{class:'control_button zoom_in',onClick:e[0]||(e[0]=e=>t.$emit('zoom-in')),onTouchstart:e[1]||(e[1]=(0,n.withModifiers)(e=>t.$emit('zoom-in'),['prevent'])),title:'放大'},[...e[6]||(e[6]=[(0,n.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])],32),(0,n.createElementVNode)('button',{class:'control_button zoom_out',onClick:e[2]||(e[2]=e=>t.$emit('zoom-out')),onTouchstart:e[3]||(e[3]=(0,n.withModifiers)(e=>t.$emit('zoom-out'),['prevent'])),title:'缩小'},[...e[7]||(e[7]=[(0,n.createElementVNode)('i',{class:'fa-solid fa-minus'},null,-1)])],32),(0,n.createElementVNode)('button',{class:'control_button reset_view',onClick:e[4]||(e[4]=e=>t.$emit('reset-view')),onTouchstart:e[5]||(e[5]=(0,n.withModifiers)(e=>t.$emit('reset-view'),['prevent'])),title:'重置视图'},[...e[8]||(e[8]=[(0,n.createElementVNode)('i',{class:'fa-solid fa-expand-arrows-alt'},null,-1)])],32)]))});a(229);var h=a(441);const l=(0,h.A)(c,[['__scopeId','data-v-2de7aaed']]),d={class:'map_graph'},A={class:'map_container'},p={class:'map_title_bar'},m={class:'map_title'},u={class:'map_movement'},f={key:0,class:'zoom_indicator'},g=(0,n.defineComponent)({__name:'MapContainer',props:{mapText:{}},setup(t){const e=t,a=(0,n.ref)(null);let r=null,c=null,h=null;const g=(0,n.ref)(null),x=(0,n.ref)(!1),v=(0,n.ref)(1),C=(0,n.ref)(!1);let b=null;const S=(0,n.computed)(()=>g.value?.metadata.description||'交互式地图系统'),w=(0,n.computed)(()=>{const t={F:{class:'fa-solid fa-arrows-alt',text:'自由移动模式'},A:{class:'fa-solid fa-route',text:'临近移动模式'},N:{class:'fa-solid fa-ban',text:'禁止移动模式'}};return t[g.value?.free_movement||'A']||t.A}),E=()=>{if(e.mapText)try{g.value=o.parseMapData(e.mapText)}catch(t){console.error('[MapComponent] 解析地图数据失败:',t)}},y=()=>{c&&(c.zoomIn(),T(),L())},M=()=>{c&&(c.zoomOut(),T(),L())},D=()=>{if(!c||!r)return;const t=r.getMapBounds();c.resetView(t||void 0),T(),L()},B=()=>{if(!a.value)return;let t;const e=a.value,n=()=>{x.value=!0,clearTimeout(t)},i=()=>{clearTimeout(t),t=setTimeout(()=>{x.value=!1},100)};e.addEventListener('mousedown',n),e.addEventListener('touchstart',n),e.addEventListener('mouseup',i),e.addEventListener('mouseleave',i),e.addEventListener('touchend',i)},T=()=>{r&&(v.value=r.getViewState().scale)},L=()=>{C.value=!0,b&&clearTimeout(b),b=setTimeout(()=>{C.value=!1},1500)},k=()=>{a.value&&r&&(h=new ResizeObserver(()=>{r&&r.render()}),h.observe(a.value))};return(0,n.watch)(()=>e.mapText,()=>{E(),g.value&&r&&r.setMapData(g.value)},{immediate:!0}),(0,n.onMounted)(()=>{E();const t=window.innerWidth<=768?200:100;setTimeout(()=>{(()=>{if(a.value&&g.value)try{r=new i(a.value),r.setMapData(g.value),c=new s(a.value,r),B(),k(),T()}catch(t){console.error('[MapComponent] 渲染器初始化失败:',t)}})()},t)}),(0,n.onUnmounted)(()=>{r&&(r.cleanup(),r=null),c&&(c.cleanup(),c=null),h&&(h.disconnect(),h=null),b&&(clearTimeout(b),b=null)}),(t,e)=>((0,n.openBlock)(),(0,n.createElementBlock)('div',d,[(0,n.createElementVNode)('div',A,[(0,n.createElementVNode)('div',p,[(0,n.createElementVNode)('div',m,(0,n.toDisplayString)(S.value),1),(0,n.createElementVNode)('div',u,[(0,n.createElementVNode)('i',{class:(0,n.normalizeClass)(w.value.class)},null,2),(0,n.createTextVNode)((0,n.toDisplayString)(w.value.text),1)])]),(0,n.createElementVNode)('div',{class:(0,n.normalizeClass)(['monitor-screen',{grabbing:x.value}])},[(0,n.createElementVNode)('canvas',{ref_key:'mapCanvas',ref:a},null,512),(0,n.createCommentVNode)(' 使用独立的控制组件 '),(0,n.createVNode)(l,{onZoomIn:y,onZoomOut:M,onResetView:D}),(0,n.createCommentVNode)(' 缩放提示 '),C.value?((0,n.openBlock)(),(0,n.createElementBlock)('div',f,(0,n.toDisplayString)(Math.round(100*v.value))+'%',1)):(0,n.createCommentVNode)('v-if',!0)],2)])]))}});a(374);const x=(0,h.A)(g,[['__scopeId','data-v-ca1729aa']]);class v{static instance=null;activeApps=new Map;constructor(){this.setupEventListeners()}static getInstance(){return this.instance??=new v,this.instance}renderMessage=async t=>{try{const e=getChatMessages(parseInt(t.toString(),10));if(!e?.length||!e[0]?.message)return;const a=e[0].message,n=o.extractMapFromText(a);if(!n)return;const i=this.findMessageElement(t.toString());if(!i?.length)return;this.cleanupMessage(t.toString()),this.createMapContainer(i,n,t.toString())}catch(e){console.error(`[MapGraph] 渲染消息 ${t} 失败:`,e)}};findMessageElement(t){const e=[`.mes[mesid="${t}"] .mes_text`,`.mes[mesid="${t}"]`];for(const t of e){const e=$(t,window.parent.document);if(e.length>0){const t=e.find('.mes_text');return t.length>0?t:e}}return $()}createMapContainer(t,e,a){try{const i=o.parseMapData(e);if(!i||0===i.nodes.length)return void console.warn(`[MapGraph] 地图数据为空或无效: ${a}`);const s=`map-mount-${a}`,r=$(`<div id="${s}"></div>`);t.append(r);const c=(0,n.createApp)(x,{mapText:e});c.mount(r[0]),setTimeout(()=>{this.teleportStyle()},100),this.activeApps.set(a,{app:c,mountPoint:r,mapData:i})}catch(t){console.error('[MapGraph] 创建地图组件失败:',t)}}teleportStyle(){$(`head > div[script_id="${getScriptId()}"]`,window.parent.document).length||($('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone()).appendTo($('head',window.parent.document)),console.log('[MapGraph] 样式已注入到酒馆页面 <head>'))}deteleportStyle(){$(`head > div[script_id="${getScriptId()}"]`,window.parent.document).remove()}cleanupMessage(t){const e=this.activeApps.get(t);if(e)try{e.app.unmount(),e.mountPoint.remove(),this.activeApps.delete(t)}catch(t){console.error('[MapGraph] 清理组件失败:',t)}}setupEventListeners(){const t=_.debounce(async t=>{await this.renderMessage(t)},500);eventOn(tavern_events.MESSAGE_RECEIVED,t),eventOn(tavern_events.MESSAGE_UPDATED,t),eventOn(tavern_events.MESSAGE_SWIPED,t),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,t)}cleanup(){this.activeApps.forEach((t,e)=>{this.cleanupMessage(e)}),this.activeApps.clear(),this.deteleportStyle()}getStats(){return{activeApps:this.activeApps.size,mapData:Array.from(this.activeApps.values()).map(t=>({nodeCount:t.mapData?.nodes?.length||0,edgeCount:t.mapData?.edges?.length||0,movement:t.mapData?.free_movement}))}}}let C;$(()=>{C=v.getInstance(),eventOn(tavern_events.APP_READY,()=>{setTimeout(()=>{C.renderMessage(getLastMessageId())},1e3)}),console.log('[MapGraph] 地图图形系统已初始化')}),$(window).on('pagehide',()=>{C&&C.cleanup()});export{v as MapGraphManager};
//# sourceMappingURL=index.js.map