var t={99:t=>{t.exports=function(t){var e=[];return e.toString=function(){return this.map(function(e){var a='',i=void 0!==e[5];return e[4]&&(a+='@supports ('.concat(e[4],') {')),e[2]&&(a+='@media '.concat(e[2],' {')),i&&(a+='@layer'.concat(e[5].length>0?' '.concat(e[5]):'',' {')),a+=t(e),i&&(a+='}'),e[2]&&(a+='}'),e[4]&&(a+='}'),a}).join('')},e.i=function(t,a,i,s,n){'string'==typeof t&&(t=[[null,t,void 0]]);var o={};if(i)for(var r=0;r<this.length;r++){var c=this[r][0];null!=c&&(o[c]=!0)}for(var h=0;h<t.length;h++){var l=[].concat(t[h]);i&&o[l[0]]||(void 0!==n&&(void 0===l[5]||(l[1]='@layer'.concat(l[5].length>0?' '.concat(l[5]):'',' {').concat(l[1],'}')),l[5]=n),a&&(l[2]?(l[1]='@media '.concat(l[2],' {').concat(l[1],'}'),l[2]=a):l[2]=a),s&&(l[4]?(l[1]='@supports ('.concat(l[4],') {').concat(l[1],'}'),l[4]=s):l[4]=''.concat(s)),e.push(l))}},e}},191:(t,e,a)=>{a.r(e),a.d(e,{default:()=>r});var i=a(226),s=a.n(i),n=a(99),o=a.n(n)()(s());o.push([t.id,'.map_graph[data-v-5d065916]{font-family:"Segoe UI","Tahoma","Geneva","Verdana",sans-serif;color:rgba(232,234,240,.8);margin:15px 0;position:relative;z-index:1}.map_graph .map_container[data-v-5d065916]{background-color:#16213e;padding:6px;border-radius:6px;display:flex;flex-direction:column;gap:6px;border:1px solid #e8eaf0;position:relative;overflow:hidden}.map_graph .map_title_bar[data-v-5d065916]{text-align:center}.map_graph .map_title_bar .map_title[data-v-5d065916]{color:#e8eaf0;font-size:1.1rem;margin:0;text-transform:uppercase;letter-spacing:1px}.map_graph .map_title_bar i[data-v-5d065916]{color:#4a9eff;margin-right:8px}.map_graph .monitor-screen[data-v-5d065916]{background-color:rgba(22,33,62,.5);border:1px solid #8baac7;padding:5px;box-shadow:0 0 20px rgba(74,158,255,.2) inset;position:relative;overflow:hidden;width:100%;min-height:600px;cursor:grab;border-radius:4px;touch-action:pan-x pan-y}.map_graph .monitor-screen.grabbing[data-v-5d065916]{cursor:grabbing !important}.map_graph .monitor-screen canvas[data-v-5d065916]{position:absolute;top:0;left:0;width:100%;height:100%;display:block;background-color:rgba(0,0,0,0)}.map_graph .monitor-screen .zoom_indicator[data-v-5d065916]{position:absolute;top:10px;left:10px;background:rgba(22,33,62,.9);border:1px solid #4a9eff;border-radius:6px;padding:8px 12px;color:#e8eaf0;font-size:14px;font-weight:bold;z-index:10;opacity:.9;transition:opacity .3s ease;-webkit-user-select:none;user-select:none;pointer-events:none}@media (max-width:768px){.map_graph[data-v-5d065916]{margin:10px 0}.map_graph .map_container[data-v-5d065916]{padding:8px 4px 4px 4px}.map_graph .monitor-screen[data-v-5d065916]{min-height:400px;padding:3px;touch-action:manipulation}.map_graph .monitor-screen .zoom_indicator[data-v-5d065916]{top:8px;left:8px;padding:6px 10px;font-size:12px}.map_graph .map_title_bar .map_title[data-v-5d065916]{font-size:1.1rem}.map_graph .map_title_bar .map_movement[data-v-5d065916]{font-size:.9rem}}@media (max-width:480px){.map_graph .monitor-screen[data-v-5d065916]{min-height:300px}.map_graph .monitor-screen .zoom_indicator[data-v-5d065916]{top:6px;left:6px;padding:4px 8px;font-size:11px;border-radius:4px}.map_graph .map_title_bar .map_title[data-v-5d065916]{font-size:1rem}}','']);const r=o},226:t=>{t.exports=function(t){return t[1]}},260:(t,e,a)=>{var i=a(191);i.__esModule&&(i=i.default),'string'==typeof i&&(i=[[t.id,i,'']]),i.locals&&(t.exports=i.locals);(0,a(424).A)('0b2f9a5e',i,!1,{})},424:(t,e,a)=>{function i(t,e){for(var a=[],i={},s=0;s<e.length;s++){var n=e[s],o=n[0],r={id:t+':'+s,css:n[1],media:n[2],sourceMap:n[3]};i[o]?i[o].parts.push(r):a.push(i[o]={id:o,parts:[r]})}return a}a.d(e,{A:()=>u});var s='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!s)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var n={},o=s&&(document.head||document.getElementsByTagName('head')[0]),r=null,c=0,h=!1,l=function(){},d=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function u(t,e,a,s){h=a,d=s||{};var o=i(t,e);return f(o),function(e){for(var a=[],s=0;s<o.length;s++){var r=o[s];(c=n[r.id]).refs--,a.push(c)}e?f(o=i(t,e)):o=[];for(s=0;s<a.length;s++){var c;if(0===(c=a[s]).refs){for(var h=0;h<c.parts.length;h++)c.parts[h]();delete n[c.id]}}}}function f(t){for(var e=0;e<t.length;e++){var a=t[e],i=n[a.id];if(i){i.refs++;for(var s=0;s<i.parts.length;s++)i.parts[s](a.parts[s]);for(;s<a.parts.length;s++)i.parts.push(g(a.parts[s]));i.parts.length>a.parts.length&&(i.parts.length=a.parts.length)}else{var o=[];for(s=0;s<a.parts.length;s++)o.push(g(a.parts[s]));n[a.id]={id:a.id,refs:1,parts:o}}}}function v(){var t=document.createElement('style');return t.type='text/css',o.appendChild(t),t}function g(t){var e,a,i=document.querySelector('style['+p+'~="'+t.id+'"]');if(i){if(h)return l;i.parentNode.removeChild(i)}if(m){var s=c++;i=r||(r=v()),e=S.bind(null,i,s,!1),a=S.bind(null,i,s,!0)}else i=v(),e=w.bind(null,i),a=function(){i.parentNode.removeChild(i)};return e(t),function(i){if(i){if(i.css===t.css&&i.media===t.media&&i.sourceMap===t.sourceMap)return;e(t=i)}else a()}}var x,b=(x=[],function(t,e){return x[t]=e,x.filter(Boolean).join('\n')});function S(t,e,a,i){var s=a?'':i.css;if(t.styleSheet)t.styleSheet.cssText=b(e,s);else{var n=document.createTextNode(s),o=t.childNodes;o[e]&&t.removeChild(o[e]),o.length?t.insertBefore(n,o[e]):t.appendChild(n)}}function w(t,e){var a=e.css,i=e.media,s=e.sourceMap;if(i&&t.setAttribute('media',i),d.ssrId&&t.setAttribute(p,e.id),s&&(a+='\n/*# sourceURL='+s.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(s))))+' */'),t.styleSheet)t.styleSheet.cssText=a;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(a))}}},503:(t,e,a)=>{var i=a(554);i.__esModule&&(i=i.default),'string'==typeof i&&(i=[[t.id,i,'']]),i.locals&&(t.exports=i.locals);(0,a(424).A)('1b8be81c',i,!1,{})},554:(t,e,a)=>{a.r(e),a.d(e,{default:()=>r});var i=a(226),s=a.n(i),n=a(99),o=a.n(n)()(s());o.push([t.id,'.map_controls[data-v-6cd5ecbd]{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:8px;z-index:10}.map_controls .control_button[data-v-6cd5ecbd]{width:36px;height:36px;background:rgba(22,33,62,.9);border:1px solid #4a9eff;border-radius:6px;color:#4a9eff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s ease;-webkit-user-select:none;user-select:none}.map_controls .control_button[data-v-6cd5ecbd]:hover{background:rgba(74,158,255,.2);color:#e8eaf0;transform:scale(1.05)}.map_controls .control_button[data-v-6cd5ecbd]:active{transform:scale(0.95);background:rgba(74,158,255,.4)}.map_controls .control_button i[data-v-6cd5ecbd]{pointer-events:none}@media (max-width:768px){.map_controls[data-v-6cd5ecbd]{top:8px;right:8px;gap:6px}.map_controls .control_button[data-v-6cd5ecbd]{width:32px;height:32px;font-size:12px}.map_controls .control_button[data-v-6cd5ecbd]:active{transform:scale(0.9);background:rgba(74,158,255,.5)}}@media (max-width:480px){.map_controls[data-v-6cd5ecbd]{top:6px;right:6px;gap:4px}.map_controls .control_button[data-v-6cd5ecbd]{width:30px;height:30px;font-size:11px;border-radius:4px}.map_controls .control_button[data-v-6cd5ecbd]:active{transform:scale(0.85)}}','']);const r=o},772:(t,e)=>{e.A=(t,e)=>{const a=t.__vccOpts||t;for(const[t,i]of e)a[t]=i;return a}}},e={};function a(i){var s=e[i];if(void 0!==s)return s.exports;var n=e[i]={id:i,exports:{}};return t[i](n,n.exports,a),n.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var i in e)a.o(e,i)&&!a.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(t,'__esModule',{value:!0})};const i=Vue;class s{canvas;ctx;viewState;mapData=null;get isMobile(){return window.innerWidth<=768}get isSmallMobile(){return window.innerWidth<=480}constructor(t){this.canvas=t;const e=t.getContext('2d');if(!e)throw new Error('无法获取Canvas上下文');this.ctx=e,this.viewState={offsetX:0,offsetY:0,scale:1},this.setupCanvas()}setupCanvas(){this.updateCanvasSize(),this.optimizeCanvasQuality()}optimizeCanvasQuality(){this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality='high',this.ctx.lineCap='round',this.ctx.lineJoin='round'}updateCanvasSize(){const t=window.devicePixelRatio||1,e=this.canvas.getBoundingClientRect(),a=e.width*t,i=e.height*t;this.canvas.width===a&&this.canvas.height===i||(this.canvas.width=a,this.canvas.height=i,this.canvas.style.width=e.width+'px',this.canvas.style.height=e.height+'px',this.ctx.setTransform(1,0,0,1,0,0),this.optimizeCanvasQuality())}setMapData(t){this.mapData=t,setTimeout(()=>{this.resetView(),this.render()},50)}resetView(){if(!this.mapData||0===this.mapData.nodes.length)return;this.updateCanvasSize();const t=this.mapData.nodes.map(t=>t.x),e=this.mapData.nodes.map(t=>t.y),a=Math.min(...t),i=Math.max(...t),s=Math.min(...e),n=Math.max(...e),o=i-a,r=n-s,c=this.canvas.getBoundingClientRect(),h=c.width,l=c.height;if(0===o&&0===r)return this.viewState.offsetX=-(a+i)/2,this.viewState.offsetY=-(s+n)/2,void(this.viewState.scale=1);let d=1;if(h>0&&l>0){const t=o>0?.8*h/o:1,e=r>0?.8*l/r:1;d=Math.min(t,e),d=Math.min(Math.max(d,.2),2)}this.viewState.offsetX=-(a+i)/2,this.viewState.offsetY=-(s+n)/2,this.viewState.scale=d}render(){this.mapData&&(this.updateCanvasSize(),this.clearCanvas(),this.applyTransform(),this.drawEdges(),this.drawNodes(),this.drawLabels())}clearCanvas(){this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.optimizeCanvasQuality()}applyTransform(){const{offsetX:t,offsetY:e,scale:a}=this.viewState,i=window.devicePixelRatio||1,s=this.canvas.width/2,n=this.canvas.height/2,o=a*i;this.ctx.setTransform(o,0,0,o,s+o*t,n+o*e),this.optimizeCanvasQuality()}drawEdges(){this.mapData&&this.mapData.edges.forEach(t=>{const e=this.mapData.nodes.find(e=>e.id===t.from),a=this.mapData.nodes.find(e=>e.id===t.to);if(e&&a){const i=this.getNodeEdgePoint(e,a),s=this.getNodeEdgePoint(a,e);this.drawEdge(t,i,s)}})}drawEdge(t,e,a){const i=this.isSmallMobile?.5:this.isMobile?.6:1;this.ctx.lineWidth=Math.max(.3,i/this.viewState.scale);const s='c'===t.type&&this.isEdgeConnectedToUnreachableNode(t),n=this.isSmallMobile?.6:this.isMobile?.7:Math.max(.8,1/this.viewState.scale);switch(t.type){case'l':this.ctx.strokeStyle='#ef4444',this.ctx.setLineDash([3*n,3*n]);break;case'ld':this.ctx.strokeStyle='#fbbf24',this.ctx.setLineDash([5*n,2*n]);break;case'lg':this.ctx.strokeStyle='#8b5cf6',this.ctx.setLineDash([6*n,1*n,1*n,1*n]);break;case'lb':this.ctx.strokeStyle='#ec4899',this.ctx.setLineDash([2*n,2*n]);break;case'lh':this.ctx.strokeStyle='#d1d5db',this.ctx.setLineDash([.8*n,2.5*n]);break;default:this.ctx.strokeStyle=s?'#6b7280':'#4a9eff',this.ctx.setLineDash([])}this.ctx.save();const o=(this.isSmallMobile?2:this.isMobile?3:4)/this.viewState.scale;this.ctx.shadowColor=this.ctx.strokeStyle,this.ctx.shadowBlur=o,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(a.x,a.y),this.ctx.stroke(),this.ctx.restore(),this.ctx.setLineDash([])}isEdgeConnectedToUnreachableNode(t){if(!this.mapData?.currentLocation)return!1;const e=this.mapData.nodes.find(e=>e.id===t.from),a=this.mapData.nodes.find(e=>e.id===t.to);return!(!e||!a)&&(e.id!==this.mapData.currentLocation&&a.id!==this.mapData.currentLocation&&(!this.isNodeReachable(e)||!this.isNodeReachable(a)))}getNodeEdgePoint(t,e){const a=e.x-t.x,i=e.y-t.y,s=Math.sqrt(a*a+i*i);if(0===s)return{x:t.x,y:t.y};const n=a/s,o=i/s;if('r'===t.shape){const e=(t.width||40)/2,a=(t.height||30)/2,i=[-a/o,a/o,-e/n,e/n].filter(t=>t>0),s=Math.min(...i);return{x:t.x+n*s,y:t.y+o*s}}{const e=t.radius||15;return{x:t.x+n*e,y:t.y+o*e}}}drawNodes(){this.mapData&&this.mapData.nodes.forEach(t=>{const e=t.id===this.mapData.currentLocation,a='e'===t.type,i=this.isNodeReachable(t);let s,n,o;e?(s='#14b8a6',n='#14b8a640',o='#14b8a6'):i?a?(s='#22c55e',n='#22c55e40',o='#22c55e'):(s='#4a9eff',n='#4a9eff40',o='#4a9eff'):(s='#6b7280',n='#6b728040',o='#6b7280');const r=this.isSmallMobile?.8:this.isMobile?1:1.2;this.ctx.lineWidth=Math.max(.4,r/this.viewState.scale);const c=(this.isSmallMobile?4:this.isMobile?5:6)/this.viewState.scale;if(this.ctx.save(),this.ctx.shadowColor=o,this.ctx.shadowBlur=c,this.ctx.strokeStyle=s,this.ctx.fillStyle=n,this.ctx.beginPath(),'r'===t.shape){const e=t.width||40,a=t.height||30;this.ctx.rect(t.x-e/2,t.y-a/2,e,a)}else{const e=t.radius||15;this.ctx.arc(t.x,t.y,e,0,2*Math.PI)}this.ctx.fill(),this.ctx.stroke(),this.ctx.restore(),a&&this.drawExitIcon(t)})}isNodeReachable(t){if(!this.mapData?.currentLocation)return!0;if(!this.mapData.nodes.find(t=>t.id===this.mapData.currentLocation))return!0;if('F'===this.mapData.free_movement)return!0;if('N'===this.mapData.free_movement)return t.id===this.mapData.currentLocation;return this.mapData.edges.filter(t=>(t.from===this.mapData.currentLocation||t.to===this.mapData.currentLocation)&&'c'===t.type).some(e=>(e.from===this.mapData.currentLocation?e.to:e.from)===t.id)}drawExitIcon(t){const e=(this.isMobile?8:12)/this.viewState.scale,a=t.y+('r'===t.shape?(t.height||30)/2:t.radius||15)+e+6/this.viewState.scale;this.ctx.font=`bold ${e}px "Segoe UI", sans-serif`;const i=this.ctx.measureText('EXIT').width,s=e,n=2/this.viewState.scale,o=t.x-i/2-n,r=a-s/2-1/this.viewState.scale,c=i+2*n,h=s+2/this.viewState.scale,l=2/this.viewState.scale;this.ctx.fillStyle='#22c55e',this.ctx.beginPath(),this.ctx.roundRect(o,r,c,h,l),this.ctx.fill(),this.ctx.fillStyle='#ffffff',this.ctx.textAlign='center',this.ctx.textBaseline='middle',this.ctx.fillText('EXIT',t.x,a)}drawLabels(){if(!this.mapData)return;this.ctx.textAlign='center',this.ctx.textBaseline='middle';const t=(this.isMobile?12:14)/this.viewState.scale;this.ctx.font=`${t}px "Segoe UI", sans-serif`,this.mapData.nodes.forEach(e=>{const a=e.id===this.mapData.currentLocation;if(this.ctx.fillStyle=a?'#14b8a6':'#e8eaf0',e.label&&this.ctx.fillText(e.label,e.x,e.y),a){this.ctx.fillStyle='#14b8a6',this.ctx.font=`bold ${.8*t}px "Segoe UI", sans-serif`,this.ctx.textBaseline='top';const a=e.y+('r'===e.shape?(e.height||30)/2:e.radius||15)+8/this.viewState.scale;this.ctx.fillText('[当前位置]',e.x,a),this.ctx.font=`${t}px "Segoe UI", sans-serif`,this.ctx.textBaseline='middle'}}),this.drawEdgeTypeInfo()}drawEdgeTypeInfo(){if(!this.mapData)return;const t=new Set(this.mapData.edges.map(t=>t.type)),e=[];if(t.has('c')&&e.push({type:'c',color:'#4a9eff',text:'普通路径',pattern:'────'}),t.has('l')&&e.push({type:'l',color:'#ef4444',text:'锁定路径',pattern:'- - -'}),t.has('ld')&&e.push({type:'ld',color:'#fbbf24',text:'门锁',pattern:'– – –'}),t.has('lg')&&e.push({type:'lg',color:'#8b5cf6',text:'守卫',pattern:'‒ ‒ ‒'}),t.has('lb')&&e.push({type:'lb',color:'#ec4899',text:'障碍',pattern:'··· ···'}),t.has('lh')&&e.push({type:'lh',color:'#d1d5db',text:'隐藏',pattern:'. . . .'}),0===e.length)return;this.ctx.save(),this.ctx.setTransform(1,0,0,1,0,0);const a=this.isSmallMobile?8:this.isMobile?10:12,i=this.isSmallMobile?18:this.isMobile?17:14,s=this.isSmallMobile?16:this.isMobile?14:10,n=this.isSmallMobile?30:this.isMobile?28:20,o=this.isSmallMobile?120:this.isMobile?110:90,r=this.canvas.height-a-e.length*i;this.ctx.fillStyle='rgba(22, 33, 62, 0.3)',this.ctx.fillRect(a-6,r-10,o,e.length*i+16),this.ctx.font=`${s}px "Segoe UI", sans-serif`,this.ctx.textAlign='left',this.ctx.textBaseline='top',e.forEach((t,e)=>{const s=r+e*i;this.ctx.strokeStyle=t.color,this.ctx.lineWidth=this.isSmallMobile?1.2:this.isMobile?1.4:1.5,this.ctx.lineCap='round',this.ctx.lineJoin='round';switch(t.type){case'l':this.ctx.setLineDash([3,3]);break;case'ld':this.ctx.setLineDash([5,2]);break;case'lg':this.ctx.setLineDash([6,1,1,1]);break;case'lb':this.ctx.setLineDash([2,2]);break;case'lh':this.ctx.setLineDash([.8,2.5]);break;default:this.ctx.setLineDash([])}this.ctx.save(),this.ctx.shadowColor=t.color,this.ctx.shadowBlur=3,this.ctx.beginPath(),this.ctx.moveTo(a,s+i/2),this.ctx.lineTo(a+n,s+i/2),this.ctx.stroke(),this.ctx.restore(),this.ctx.setLineDash([]),this.ctx.fillStyle='#e8eaf0',this.ctx.fillText(t.text,a+n+8,s+2)}),this.ctx.restore()}getViewState(){return{...this.viewState}}setViewState(t){Object.assign(this.viewState,t),this.render()}resetToFit(){this.resetView(),this.render()}getMapBounds(){if(!this.mapData||0===this.mapData.nodes.length)return null;const t=this.mapData.nodes.map(t=>t.x),e=this.mapData.nodes.map(t=>t.y);return{minX:Math.min(...t),maxX:Math.max(...t),minY:Math.min(...e),maxY:Math.max(...e)}}cleanup(){this.mapData=null}}class n{canvas;renderer;interactionState;config={minScale:.1,maxScale:5,zoomSensitivity:.001,touchZoomSensitivity:.005,panSensitivity:1};constructor(t,e){this.canvas=t,this.renderer=e,this.interactionState={isDragging:!1,lastPointerX:0,lastPointerY:0,lastScale:1},this.setupInteractions()}setupInteractions(){this.canvas.addEventListener('wheel',this.handleWheel.bind(this)),this.canvas.addEventListener('mousedown',this.handlePointerStart.bind(this)),this.canvas.addEventListener('mousemove',this.handlePointerMove.bind(this)),this.canvas.addEventListener('mouseup',this.handlePointerEnd.bind(this)),this.canvas.addEventListener('mouseleave',this.handlePointerEnd.bind(this)),this.canvas.addEventListener('touchstart',this.handleTouchStart.bind(this),{passive:!1}),this.canvas.addEventListener('touchmove',this.handleTouchMove.bind(this),{passive:!1}),this.canvas.addEventListener('touchend',this.handleTouchEnd.bind(this),{passive:!1}),this.canvas.addEventListener('contextmenu',t=>t.preventDefault())}handleWheel(t){t.preventDefault();const e=this.canvas.getBoundingClientRect(),a=t.clientX-e.left,i=t.clientY-e.top;this.zoomAt(a,i,-t.deltaY*this.config.zoomSensitivity)}handlePointerStart(t){0===t.button&&(this.startDrag(t.clientX,t.clientY),this.canvas.style.cursor='grabbing')}handlePointerMove(t){this.interactionState.isDragging&&this.updateDrag(t.clientX,t.clientY)}handlePointerEnd(){this.endDrag(),this.canvas.style.cursor='grab'}handleTouchStart(t){if(t.preventDefault(),1===t.touches.length){const e=t.touches[0];this.startDrag(e.clientX,e.clientY)}else if(2===t.touches.length){const e=t.touches[0],a=t.touches[1],i=this.getTouchDistance(e,a);this.interactionState.startPinchDistance=i,this.interactionState.lastScale=this.renderer.getViewState().scale,this.interactionState.isDragging=!1}}handleTouchMove(t){if(t.preventDefault(),1===t.touches.length&&this.interactionState.isDragging){const e=t.touches[0];this.updateDrag(e.clientX,e.clientY)}else if(2===t.touches.length&&this.interactionState.startPinchDistance){const e=t.touches[0],a=t.touches[1],i=(this.getTouchDistance(e,a)-this.interactionState.startPinchDistance)*this.config.touchZoomSensitivity,s=Math.max(this.config.minScale,Math.min(this.config.maxScale,this.interactionState.lastScale+i)),n=(e.clientX+a.clientX)/2,o=(e.clientY+a.clientY)/2,r=this.canvas.getBoundingClientRect();this.zoomAt(n-r.left,o-r.top,s,!1)}}handleTouchEnd(t){if(t.preventDefault(),0===t.touches.length)this.endDrag(),this.interactionState.startPinchDistance=void 0;else if(1===t.touches.length){this.interactionState.startPinchDistance=void 0;const e=t.touches[0];this.startDrag(e.clientX,e.clientY)}}startDrag(t,e){this.interactionState.isDragging=!0,this.interactionState.lastPointerX=t,this.interactionState.lastPointerY=e}updateDrag(t,e){if(!this.interactionState.isDragging)return;const a=t-this.interactionState.lastPointerX,i=e-this.interactionState.lastPointerY,s=this.renderer.getViewState(),n=s.offsetX+a/s.scale*this.config.panSensitivity,o=s.offsetY+i/s.scale*this.config.panSensitivity;this.renderer.setViewState({offsetX:n,offsetY:o}),this.interactionState.lastPointerX=t,this.interactionState.lastPointerY=e}endDrag(){this.interactionState.isDragging=!1}zoomAt(t,e,a,i=!0){const s=this.renderer.getViewState(),n=s.scale,o=i?Math.max(this.config.minScale,Math.min(this.config.maxScale,n+a)):Math.max(this.config.minScale,Math.min(this.config.maxScale,a));if(o===n)return;const r=this.canvas.getBoundingClientRect(),c=(t-r.width/2)/n-s.offsetX,h=(e-r.height/2)/n-s.offsetY,l=(t-r.width/2)/o-c,d=(e-r.height/2)/o-h;this.renderer.setViewState({scale:o,offsetX:l,offsetY:d})}getTouchDistance(t,e){const a=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(a*a+i*i)}zoomIn(){const t=this.renderer.getViewState(),e=Math.min(this.config.maxScale,1.2*t.scale);this.renderer.setViewState({scale:e})}zoomOut(){const t=this.renderer.getViewState(),e=Math.max(this.config.minScale,t.scale/1.2);this.renderer.setViewState({scale:e})}setScale(t){const e=Math.max(this.config.minScale,Math.min(this.config.maxScale,t));this.renderer.setViewState({scale:e})}resetView(t){if(t){const e=t.maxX-t.minX,a=t.maxY-t.minY,i=this.canvas.getBoundingClientRect();if(0===e&&0===a)this.renderer.setViewState({offsetX:-(t.minX+t.maxX)/2,offsetY:-(t.minY+t.maxY)/2,scale:1});else{let s=1;if(i.width>0&&i.height>0){const t=e>0?.8*i.width/e:1,n=a>0?.8*i.height/a:1;s=Math.min(t,n),s=Math.min(Math.max(s,this.config.minScale),this.config.maxScale)}this.renderer.setViewState({offsetX:-(t.minX+t.maxX)/2,offsetY:-(t.minY+t.maxY)/2,scale:s})}}else this.renderer.setViewState({offsetX:0,offsetY:0,scale:1})}getInteractionState(){return{...this.interactionState}}cleanup(){this.canvas.removeEventListener('wheel',this.handleWheel.bind(this)),this.canvas.removeEventListener('mousedown',this.handlePointerStart.bind(this)),this.canvas.removeEventListener('mousemove',this.handlePointerMove.bind(this)),this.canvas.removeEventListener('mouseup',this.handlePointerEnd.bind(this)),this.canvas.removeEventListener('mouseleave',this.handlePointerEnd.bind(this)),this.canvas.removeEventListener('touchstart',this.handleTouchStart.bind(this)),this.canvas.removeEventListener('touchmove',this.handleTouchMove.bind(this)),this.canvas.removeEventListener('touchend',this.handleTouchEnd.bind(this)),this.canvas.removeEventListener('contextmenu',t=>t.preventDefault())}}class o{static MAP_REGEX=/<MapGraph>(.*?)<\/MapGraph>/s;static LOOSE_MAP_REGEX=/<\s*MapGraph\s*>([\s\S]*?)<\s*\/\s*MapGraph\s*>/i;static extractMapFromText(t){const e=this.MAP_REGEX.exec(t)||this.LOOSE_MAP_REGEX.exec(t);return e?e[1]:null}static parseMapData(t){const e=t.split('\n'),a={nodes:[],edges:[],metadata:{},currentLocation:null,free_movement:'A'},i=new Set;e.forEach(t=>{const e=t.trim();if(!e||e.startsWith('#'))return;const s=/^n:([^|]+)\|([^|]+)\|([^|@]+)(?:@([^|]*))?(?:\|)(\d+)\|(\d+)\|([rc])\|(.*)$/i.exec(e);if(s){const t=this.parseNode(s);return void(t&&!i.has(t.id)&&(i.add(t.id),a.nodes.push(t),(t.characters.includes('current')||t.characters.includes(''))&&(a.currentLocation=t.id)))}const n=/^e:([^|]+)\|([^|]+)(?:\|([^|]+))?$/i.exec(e);if(n){const t=this.parseEdge(n);return void(t&&a.edges.push(t))}const o=/^m:([^=]+)=(.*)$/i.exec(e);o&&this.parseMetadata(o,a)});const s=new Set(a.nodes.map(t=>t.id));return a.edges=a.edges.filter(t=>s.has(t.from)&&s.has(t.to)),a}static parseNode(t){const[,e,a,i,s,n,o,r,c]=t,h=parseInt(n,10),l=parseInt(o,10);if(isNaN(h)||isNaN(l))return null;const d={id:e.trim(),type:a.trim(),label:i.trim(),x:h,y:l,shape:r.toLowerCase().trim(),characters:s?s.split(',').map(t=>t.trim()).filter(Boolean):[]};if('r'===d.shape){const t=/^(\d+)x(\d+)$/i.exec(c);t?(d.width=parseInt(t[1],10),d.height=parseInt(t[2],10)):(d.width=40,d.height=30)}else if('c'===d.shape){const t=parseInt(c,10);d.radius=isNaN(t)?15:t}return d}static parseEdge(t){const[,e,a,i]=t;return{from:e.trim(),to:a.trim(),type:i?i.trim():'c'}}static parseMetadata(t,e){const[,a,i]=t,s=a.trim().toLowerCase();if('fm'===s){const t=i.trim().toUpperCase();['F','A','N'].includes(t)&&(e.free_movement=t)}else'desc'===s?e.metadata.description=i.trim():e.metadata[s]=i.trim()}}const r={class:'map_controls'},c=(0,i.defineComponent)({__name:'MapControls',emits:['zoom-in','zoom-out','reset-view'],setup:t=>(t,e)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',r,[(0,i.createElementVNode)('button',{class:'control_button zoom_in',onClick:e[0]||(e[0]=e=>t.$emit('zoom-in')),onTouchstart:e[1]||(e[1]=(0,i.withModifiers)(e=>t.$emit('zoom-in'),['prevent'])),title:'放大'},[...e[6]||(e[6]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-plus'},null,-1)])],32),(0,i.createElementVNode)('button',{class:'control_button zoom_out',onClick:e[2]||(e[2]=e=>t.$emit('zoom-out')),onTouchstart:e[3]||(e[3]=(0,i.withModifiers)(e=>t.$emit('zoom-out'),['prevent'])),title:'缩小'},[...e[7]||(e[7]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-minus'},null,-1)])],32),(0,i.createElementVNode)('button',{class:'control_button reset_view',onClick:e[4]||(e[4]=e=>t.$emit('reset-view')),onTouchstart:e[5]||(e[5]=(0,i.withModifiers)(e=>t.$emit('reset-view'),['prevent'])),title:'重置视图'},[...e[8]||(e[8]=[(0,i.createElementVNode)('i',{class:'fa-solid fa-expand-arrows-alt'},null,-1)])],32)]))});a(503);var h=a(772);const l=(0,h.A)(c,[['__scopeId','data-v-6cd5ecbd']]),d={class:'map_graph'},p={class:'map_container'},m={class:'map_title_bar'},u={class:'map_title'},f={class:'map_movement'},v={key:0,class:'zoom_indicator'},g=(0,i.defineComponent)({__name:'MapContainer',props:{mapText:{}},setup(t){const e=t,a=(0,i.ref)(null);let r=null,c=null,h=null;const g=(0,i.ref)(null),x=(0,i.ref)(!1),b=(0,i.ref)(1),S=(0,i.ref)(!1);let w=null;const y=(0,i.computed)(()=>g.value?.metadata.description||'交互式地图系统'),M=(0,i.computed)(()=>{const t={F:{class:'fa-solid fa-arrows-alt',text:'自由移动模式'},A:{class:'fa-solid fa-route',text:'临近移动模式'},N:{class:'fa-solid fa-ban',text:'禁止移动模式'}};return t[g.value?.free_movement||'A']||t.A}),E=()=>{if(e.mapText)try{g.value=o.parseMapData(e.mapText)}catch(t){console.error('[MapComponent] 解析地图数据失败:',t)}},D=()=>{c&&(c.zoomIn(),N(),P())},C=()=>{c&&(c.zoomOut(),N(),P())},T=()=>{if(!c||!r)return;const t=r.getMapBounds();c.resetView(t||void 0),N(),P()},L=()=>{if(!a.value)return;let t;const e=a.value,i=()=>{x.value=!0,clearTimeout(t)},s=()=>{clearTimeout(t),t=setTimeout(()=>{x.value=!1},100)};e.addEventListener('mousedown',i),e.addEventListener('touchstart',i),e.addEventListener('mouseup',s),e.addEventListener('mouseleave',s),e.addEventListener('touchend',s)},N=()=>{r&&(b.value=r.getViewState().scale)},P=()=>{S.value=!0,w&&clearTimeout(w),w=setTimeout(()=>{S.value=!1},1500)},k=()=>{a.value&&r&&(h=new ResizeObserver(()=>{r&&r.render()}),h.observe(a.value))};return(0,i.watch)(()=>e.mapText,()=>{E(),g.value&&r&&r.setMapData(g.value)},{immediate:!0}),(0,i.onMounted)(()=>{E();const t=window.innerWidth<=768?200:100;setTimeout(()=>{(()=>{if(a.value&&g.value)try{r=new s(a.value),r.setMapData(g.value),c=new n(a.value,r),L(),k(),N()}catch(t){console.error('[MapComponent] 渲染器初始化失败:',t)}})()},t)}),(0,i.onUnmounted)(()=>{r&&(r.cleanup(),r=null),c&&(c.cleanup(),c=null),h&&(h.disconnect(),h=null),w&&(clearTimeout(w),w=null)}),(t,e)=>((0,i.openBlock)(),(0,i.createElementBlock)('div',d,[(0,i.createElementVNode)('div',p,[(0,i.createElementVNode)('div',m,[(0,i.createElementVNode)('div',u,(0,i.toDisplayString)(y.value),1),(0,i.createElementVNode)('div',f,[(0,i.createElementVNode)('i',{class:(0,i.normalizeClass)(M.value.class)},null,2),(0,i.createTextVNode)((0,i.toDisplayString)(M.value.text),1)])]),(0,i.createElementVNode)('div',{class:(0,i.normalizeClass)(['monitor-screen',{grabbing:x.value}])},[(0,i.createElementVNode)('canvas',{ref_key:'mapCanvas',ref:a},null,512),(0,i.createCommentVNode)(' 使用独立的控制组件 '),(0,i.createVNode)(l,{onZoomIn:D,onZoomOut:C,onResetView:T}),(0,i.createCommentVNode)(' 缩放提示 '),S.value?((0,i.openBlock)(),(0,i.createElementBlock)('div',v,(0,i.toDisplayString)(Math.round(100*b.value))+'% ',1)):(0,i.createCommentVNode)('v-if',!0)],2)])]))}});a(260);const x=(0,h.A)(g,[['__scopeId','data-v-5d065916']]);class b{static instance=null;activeApps=new Map;constructor(){this.setupEventListeners()}static getInstance(){return this.instance??=new b,this.instance}renderMessage=async t=>{try{const e=getChatMessages(parseInt(t.toString(),10));if(!e?.length||!e[0]?.message)return;const a=e[0].message,i=o.extractMapFromText(a);if(!i)return;const s=this.findMessageElement(t.toString());if(!s?.length)return;this.cleanupMessage(t.toString()),this.createMapContainer(s,i,t.toString())}catch(e){console.error(`[MapGraph] 渲染消息 ${t} 失败:`,e)}};findMessageElement(t){const e=[`.mes[mesid="${t}"] .mes_text`,`.mes[mesid="${t}"]`];for(const t of e){const e=$(t,window.parent.document);if(e.length>0){const t=e.find('.mes_text');return t.length>0?t:e}}return $()}createMapContainer(t,e,a){try{const s=o.parseMapData(e);if(!s||0===s.nodes.length)return void console.warn(`[MapGraph] 地图数据为空或无效: ${a}`);const n=`map-mount-${a}`,r=$(`<div id="${n}"></div>`);t.append(r);const c=(0,i.createApp)(x,{mapText:e});c.mount(r[0]),setTimeout(()=>{this.handleStyleInjection(r)},100),this.activeApps.set(a,{app:c,mountPoint:r,mapData:s})}catch(t){console.error('[MapGraph] 创建地图组件失败:',t)}}handleStyleInjection(t){const e=new Set;t.find('div').each(function(){this.getAttributeNames().forEach(t=>{t.startsWith('data-v-')&&e.add(t)})}),e.forEach(e=>{const a=$(`head > style:contains("${e}")`,document);if(a.length&&!t.find(`style[data-scope="${e}"]`).length){const i=a.clone().attr('data-scope',e);t.append(i)}})}cleanupMessage(t){const e=this.activeApps.get(t);if(e)try{e.app.unmount(),e.mountPoint.remove(),this.activeApps.delete(t)}catch(t){console.error('[MapGraph] 清理组件失败:',t)}}setupEventListeners(){const t=_.debounce(async t=>{await this.renderMessage(t)},500);eventOn(tavern_events.MESSAGE_RECEIVED,t),eventOn(tavern_events.MESSAGE_UPDATED,t),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,t)}cleanup(){this.activeApps.forEach((t,e)=>{this.cleanupMessage(e)}),this.activeApps.clear()}getStats(){return{activeApps:this.activeApps.size,mapData:Array.from(this.activeApps.values()).map(t=>({nodeCount:t.mapData?.nodes?.length||0,edgeCount:t.mapData?.edges?.length||0,movement:t.mapData?.free_movement}))}}}let S;$(()=>{S=b.getInstance(),eventOn(tavern_events.APP_READY,()=>{setTimeout(()=>{S.renderMessage(getLastMessageId())},1e3)}),console.log('[MapGraph] 地图图形系统已初始化')}),$(window).on('pagehide',()=>{S&&S.cleanup()});export{b as MapGraphManager};