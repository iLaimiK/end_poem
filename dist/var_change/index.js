const t='_internal.previousSecondaryCharacters';function e(t){return t.trim().split('·')[0].trim()}function n(t){const e=_.get(t,'全局信息',{});return{时间:_.get(e,'时间',''),地点:_.get(e,'当前位置',''),日期:_.get(e,'日期','')}}function o(t,o){_.has(t,'次要角色记录')||_.set(t,'次要角色记录',{});const a=n(t),s=e(o),r=`次要角色记录.${s}`,c=`次要角色.${o}`,i=_.get(t,r);if(i&&'object'==typeof i){console.log(`[次要角色管理] ${o} (记录名: ${s}) 重新出场，恢复记录信息`);const e=_.get(i,'信任值',.01);_.has(t,`${c}.信任值`)&&(_.set(t,`${c}.信任值`,e),console.log(`[次要角色管理] 恢复 ${o} 的信任值: ${e}`));const n=_.get(i,'离场时持有的物品',{}),l=_.get(t,`${c}.持有物品`,{});if(Object.keys(n).length>0){const e={...n,...l};_.set(t,`${c}.持有物品`,e),console.log(`[次要角色管理] 恢复 ${o} 的物品，合并${Object.keys(n).length}件之前的物品`)}_.set(t,`${r}.出场次数`,_.get(i,'出场次数',0)+1),_.set(t,`${r}.出场地点`,a.地点),_.set(t,`${r}.出场时间`,`${a.日期} ${a.时间}`),_.set(t,`${r}.离场地点`,'待定'),_.set(t,`${r}.离场时间`,'N/A')}else{console.log(`[次要角色管理] ${o} (记录名: ${s}) 首次出场，创建新记录`);const e={出场次数:1,出场地点:a.地点,出场时间:`${a.日期} ${a.时间}`,离场地点:'待定',离场时间:'N/A',信任值:_.get(t,`${c}.信任值`,.01),离场时持有的物品:{}};_.set(t,r,e)}console.log(`[次要角色管理] ${o} 出场记录已更新`)}function a(t,o,a){_.has(t,'次要角色记录')||_.set(t,'次要角色记录',{});const s=n(t),r=e(o),c=`次要角色记录.${r}`;if(console.log(`[次要角色管理] ${o} (记录名: ${r}) 离场，保存当前状态`),!_.has(t,c)){const e={出场次数:1,出场地点:'',出场时间:'',离场地点:'待定',离场时间:'N/A',信任值:.01,离场时持有的物品:{}};_.set(t,c,e)}_.set(t,`${c}.离场地点`,s.地点),_.set(t,`${c}.离场时间`,`${s.日期} ${s.时间}`);const i=_.get(a,'信任值',.01);_.set(t,`${c}.信任值`,i);const l=_.get(a,'持有物品',{});_.set(t,`${c}.离场时持有的物品`,l),console.log(`[次要角色管理] ${o} 离场状态已保存 - 信任值: ${i}, 物品数量: ${Object.keys(l).length}`)}const s={'主要角色.白.关注度':{minChange:-.014,maxChange:.026},'主要角色.澪.好感度':{minChange:-.05,maxChange:.08},'主要角色.澪.治愈进度':{minChange:-5,maxChange:Number.POSITIVE_INFINITY},pattern_信任值:{minChange:-.15,maxChange:.2},pattern_好感度:{minChange:-.05,maxChange:.08},pattern_依赖度:{minChange:-.05,maxChange:.08},pattern_认可度:{minChange:-.05,maxChange:.08},pattern_污秽侵蚀度:{minChange:-.05,maxChange:.1},pattern_模因侵蚀率:{minChange:-.3,maxChange:.05}};function r(t,e,n){if('number'!=typeof t||'number'!=typeof n)return t;const o=function(t){if(s[t])return s[t];if(t.includes('次要角色')&&t.endsWith('.信任值'))return s.pattern_信任值;if(t.includes('特殊角色')){if(t.endsWith('.好感度'))return s.pattern_好感度;if(t.endsWith('.依赖度'))return s.pattern_依赖度;if(t.endsWith('.认可度'))return s.pattern_认可度;if(t.endsWith('.污秽侵蚀度'))return s.pattern_污秽侵蚀度;if(t.endsWith('.模因侵蚀率'))return s.pattern_模因侵蚀率}return null}(e);if(!o)return t;const a=function(t,e,n,o){const a=t-e;if(n.maxChange===Number.POSITIVE_INFINITY){if(a<0&&a<n.minChange){const t=e+n.minChange;return console.log(`变化幅度限制: ${o} 负向变化 ${a.toFixed(5)} 限制为 ${n.minChange}`),t}return t}if(a>n.maxChange){const t=e+n.maxChange;return console.log(`变化幅度限制: ${o} 正向变化 ${a.toFixed(5)} 限制为 ${n.maxChange}`),t}if(a<n.minChange){const t=e+n.minChange;return console.log(`变化幅度限制: ${o} 负向变化 ${a.toFixed(5)} 限制为 ${n.minChange}`),t}return t}(t,n,o,e);return a}const c='var-change-worldbook-scan';const i=[];function l(e){if(console.log('Variable update started'),e?.stat_data){const n=_.get(e.stat_data,'次要角色');_.set(e.stat_data,t,_.cloneDeep(n))}}function g(t,e,n,o){console.log(`Variable updated: ${e} from ${n} to ${o}`),i.push({stat_data:t,path:e,oldValue:n,newValue:o}),function(t,e,n,o){'plot_record.剧情进度'===e&&(console.log(`剧情进度从 "${n}" 变更为 "${o}"`),_.has(t,'plot_record.剧情节点记录')&&(_.set(t,'plot_record.剧情节点记录',[]),console.log('已清空剧情节点记录')))}(t,e,n,o),function(t,e,n){'主要角色.澪.注入星尘稳定剂'===e&&!0===n&&(console.log('澪.注入星尘稳定剂 的值变为 true，设置治愈进度为 90'),_.has(t,'主要角色.澪.治愈进度')&&(_.set(t,'主要角色.澪.治愈进度',90),console.log('澪的治愈进度已设置为 90'))),'主要角色.澪.治愈进度'===e&&!0===_.get(t,'主要角色.澪.注入星尘稳定剂')&&(console.log('澪已注入星尘稳定剂，治愈进度不得修改，恢复为 90'),_.set(t,'主要角色.澪.治愈进度',90))}(t,e,o)}function u(e){if(console.log('Variable update ended'),i.length>0){console.log(`[变化幅度限制] 处理 ${i.length} 个待限制的变量更新`);for(const t of i){const{stat_data:e,path:n,oldValue:o,newValue:a}=t,s=_.get(e,n),c=r(s,n,o);c!==s&&(_.set(e,n,c),console.log(`[变化幅度限制] 已应用限制: ${n} = ${c}`))}i.length=0}if(e?.stat_data){const n=_.get(e.stat_data,'次要角色'),s=_.get(e.stat_data,t);s&&n&&function(t,e,n){if(!e||!n)return;const s=Object.keys(e),r=Object.keys(n),c=r.filter(t=>!s.includes(t));for(const e of c)o(t,e);const i=s.filter(t=>!r.includes(t));for(const n of i)a(t,n,e[n])}(e.stat_data,s,n),_.set(e.stat_data,t,_.cloneDeep(n)),function(t){const e=[],n=_.get(t,'全局信息.当前位置','');n&&'string'==typeof n&&e.push(n.trim());const o=_.get(t,'次要角色',{});if(_.isObject(o)&&!Array.isArray(o))for(const t of Object.keys(o))t&&'string'==typeof t&&e.push(t.trim());const a=[...new Set(e)].filter(t=>t.length>0);if(a.length>0){uninjectPrompts([c]);const t=a.join(', ');try{injectPrompts([{id:c,position:'none',depth:0,role:'user',content:t,should_scan:!0}]),console.log(`[世界书扫描] 注入扫描文本: ${t}`)}catch(t){console.warn('[世界书扫描] 注入扫描文本失败:',t instanceof Error?t.message:String(t))}}else uninjectPrompts([c])}(e.stat_data)}}$(()=>{eventOn('mag_variable_update_started',l),eventOn('mag_variable_updated',g),eventOn('mag_variable_update_ended',u),console.log('MVU变量处理脚本已加载')});