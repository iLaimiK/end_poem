{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/var_change/config/constants.ts","src://tavern_helper_template/src/var_change/utils/character-utils.ts","src://tavern_helper_template/src/var_change/handlers/character-handler.ts","src://tavern_helper_template/src/var_change/config/change-limits.ts","src://tavern_helper_template/src/var_change/handlers/validation-handler.ts","src://tavern_helper_template/src/var_change/handlers/worldbook-handler.ts","src://tavern_helper_template/src/var_change/index.ts","src://tavern_helper_template/src/var_change/handlers/plot-handler.ts","src://tavern_helper_template/src/var_change/handlers/special-handler.ts"],"sourcesContent":["import type { InternalKeys } from '../types/constants';\n\n/**\n * 内部常量定义\n */\nexport const INTERNAL_KEYS: InternalKeys = {\n  /** 次要角色状态存储键名（存储在stat_data中以确保持久性） */\n  PREVIOUS_SECONDARY_CHARACTERS_KEY: '_internal.previousSecondaryCharacters',\n} as const;\n","import type { CurrentTimeAndLocation } from '../types/index';\r\n\r\n/**\r\n * 获取角色的标准化名字（用于记录key，避免重复）\r\n * @param characterName - 角色名称\r\n * @returns 标准化的名字\r\n */\r\nexport function getStandardizedRecordName(characterName: string): string {\r\n  const normalizedInput = characterName.trim();\r\n  // 返回输入的第一个名字\r\n  return normalizedInput.split('·')[0].trim();\r\n}\r\n\r\n/**\r\n * 获取当前全局信息中的时间和地点\r\n * @param stat_data - stat_data对象\r\n * @returns 包含时间和地点的对象\r\n */\r\nexport function getCurrentTimeAndLocation(stat_data: Record<string, any>): CurrentTimeAndLocation {\r\n  const globalInfo = _.get(stat_data, '全局信息', {});\r\n  return {\r\n    时间: _.get(globalInfo, '时间', ''),\r\n    地点: _.get(globalInfo, '当前位置', ''),\r\n    日期: _.get(globalInfo, '日期', ''),\r\n  };\r\n}\r\n","import type { CharacterRecord } from '../types/index';\nimport { getCurrentTimeAndLocation, getStandardizedRecordName } from '../utils/character-utils';\n\n/**\n * 处理次要角色出场\n * @param stat_data - stat_data对象\n * @param characterName - 角色名称\n */\nexport function handleSecondaryCharacterEntry(stat_data: Record<string, any>, characterName: string): void {\n  if (!_.has(stat_data, '次要角色记录')) {\n    _.set(stat_data, '次要角色记录', {});\n  }\n\n  const currentInfo = getCurrentTimeAndLocation(stat_data);\n\n  // 使用标准化的名字作为记录key，避免同一人物多次记录\n  const standardizedName = getStandardizedRecordName(characterName);\n  const recordPath = `次要角色记录.${standardizedName}`;\n  const characterPath = `次要角色.${characterName}`;\n\n  // 检查是否已有记录\n  const characterRecord = _.get(stat_data, recordPath);\n  const isReturning = characterRecord && typeof characterRecord === 'object';\n\n  if (isReturning) {\n    // 角色重新出场 - 恢复信任值\n    console.log(`[次要角色管理] ${characterName} (记录名: ${standardizedName}) 重新出场，恢复记录信息`);\n\n    // 恢复信任值\n    const savedTrustValue = _.get(characterRecord, '信任值', 0.01);\n    if (_.has(stat_data, `${characterPath}.信任值`)) {\n      _.set(stat_data, `${characterPath}.信任值`, savedTrustValue);\n      console.log(`[次要角色管理] 恢复 ${characterName} 的信任值: ${savedTrustValue}`);\n    }\n\n    // 恢复物品（合并，新物品优先）\n    const savedItems = _.get(characterRecord, '离场时持有的物品', {});\n    const currentItems = _.get(stat_data, `${characterPath}.持有物品`, {});\n\n    if (Object.keys(savedItems).length > 0) {\n      // 合并物品：当前物品优先，然后添加之前的物品\n      const mergedItems = { ...savedItems, ...currentItems };\n\n      _.set(stat_data, `${characterPath}.持有物品`, mergedItems);\n      console.log(`[次要角色管理] 恢复 ${characterName} 的物品，合并${Object.keys(savedItems).length}件之前的物品`);\n    }\n\n    // 更新出场信息\n    _.set(stat_data, `${recordPath}.出场次数`, _.get(characterRecord, '出场次数', 0) + 1);\n    _.set(stat_data, `${recordPath}.出场地点`, currentInfo.地点);\n    _.set(stat_data, `${recordPath}.出场时间`, `${currentInfo.日期} ${currentInfo.时间}`);\n    _.set(stat_data, `${recordPath}.离场地点`, '待定');\n    _.set(stat_data, `${recordPath}.离场时间`, 'N/A');\n  } else {\n    // 首次出场 - 创建新记录\n    console.log(`[次要角色管理] ${characterName} (记录名: ${standardizedName}) 首次出场，创建新记录`);\n\n    const newRecord: CharacterRecord = {\n      出场次数: 1,\n      出场地点: currentInfo.地点,\n      出场时间: `${currentInfo.日期} ${currentInfo.时间}`,\n      离场地点: '待定',\n      离场时间: 'N/A',\n      信任值: _.get(stat_data, `${characterPath}.信任值`, 0.01),\n      离场时持有的物品: {},\n    };\n\n    _.set(stat_data, recordPath, newRecord);\n  }\n\n  console.log(`[次要角色管理] ${characterName} 出场记录已更新`);\n}\n\n/**\n * 处理次要角色离场\n * @param stat_data - stat_data对象\n * @param characterName - 角色名称\n * @param characterData - 角色数据（离场前的数据）\n */\nexport function handleSecondaryCharacterExit(\n  stat_data: Record<string, any>,\n  characterName: string,\n  characterData: Record<string, any>,\n): void {\n  if (!_.has(stat_data, '次要角色记录')) {\n    _.set(stat_data, '次要角色记录', {});\n  }\n\n  const currentInfo = getCurrentTimeAndLocation(stat_data);\n\n  // 使用标准化的名字作为记录key\n  const standardizedName = getStandardizedRecordName(characterName);\n  const recordPath = `次要角色记录.${standardizedName}`;\n\n  console.log(`[次要角色管理] ${characterName} (记录名: ${standardizedName}) 离场，保存当前状态`);\n\n  // 确保有基础记录\n  if (!_.has(stat_data, recordPath)) {\n    const defaultRecord: CharacterRecord = {\n      出场次数: 1,\n      出场地点: '',\n      出场时间: '',\n      离场地点: '待定',\n      离场时间: 'N/A',\n      信任值: 0.01,\n      离场时持有的物品: {},\n    };\n    _.set(stat_data, recordPath, defaultRecord);\n  }\n\n  // 保存离场信息\n  _.set(stat_data, `${recordPath}.离场地点`, currentInfo.地点);\n  _.set(stat_data, `${recordPath}.离场时间`, `${currentInfo.日期} ${currentInfo.时间}`);\n\n  // 保存当前信任值\n  const currentTrust = _.get(characterData, '信任值', 0.01);\n  _.set(stat_data, `${recordPath}.信任值`, currentTrust);\n\n  // 保存当前持有物品\n  const currentItems = _.get(characterData, '持有物品', {});\n  _.set(stat_data, `${recordPath}.离场时持有的物品`, currentItems);\n\n  console.log(\n    `[次要角色管理] ${characterName} 离场状态已保存 - 信任值: ${currentTrust}, 物品数量: ${Object.keys(currentItems).length}`,\n  );\n}\n\n/**\n * 检测次要角色的变化（添加/删除）\n * @param stat_data - stat_data对象\n * @param oldSecondaryCharacters - 旧的次要角色对象\n * @param newSecondaryCharacters - 新的次要角色对象\n */\nexport function detectSecondaryCharacterChanges(\n  stat_data: Record<string, any>,\n  oldSecondaryCharacters: Record<string, any>,\n  newSecondaryCharacters: Record<string, any>,\n): void {\n  if (!oldSecondaryCharacters || !newSecondaryCharacters) {\n    return;\n  }\n\n  const oldCharNames = Object.keys(oldSecondaryCharacters);\n  const newCharNames = Object.keys(newSecondaryCharacters);\n\n  // 检测新增角色（出场）\n  const addedCharacters = newCharNames.filter(name => !oldCharNames.includes(name));\n  for (const characterName of addedCharacters) {\n    handleSecondaryCharacterEntry(stat_data, characterName);\n  }\n\n  // 检测删除角色（离场）\n  const removedCharacters = oldCharNames.filter(name => !newCharNames.includes(name));\n  for (const characterName of removedCharacters) {\n    const characterData = oldSecondaryCharacters[characterName];\n    handleSecondaryCharacterExit(stat_data, characterName, characterData);\n  }\n}\n","import type { ChangeLimitsConfig } from '../types/index';\n\n/**\n * 数值变化限制配置\n */\nexport const CHANGE_LIMITS: ChangeLimitsConfig = {\n  // 主要角色变化限制\n  '主要角色.白.关注度': {\n    minChange: -0.014,\n    maxChange: 0.026,\n  },\n  '主要角色.澪.好感度': {\n    minChange: -0.05,\n    maxChange: 0.08,\n  },\n  '主要角色.澪.治愈进度': {\n    minChange: -5,\n    maxChange: Number.POSITIVE_INFINITY, // 正向变化不限制\n  },\n\n  // 模式匹配变化限制\n  pattern_信任值: { minChange: -0.15, maxChange: 0.2 },\n  pattern_好感度: { minChange: -0.05, maxChange: 0.08 },\n  pattern_依赖度: { minChange: -0.05, maxChange: 0.08 },\n  pattern_认可度: { minChange: -0.05, maxChange: 0.08 },\n  pattern_污秽侵蚀度: {\n    minChange: -0.05,\n    maxChange: 0.1,\n  },\n  pattern_模因侵蚀率: {\n    minChange: -0.3,\n    maxChange: 0.05,\n  },\n};\n","import { CHANGE_LIMITS } from '../config/change-limits';\nimport type { ChangeLimitConfig } from '../types/index';\n\n/**\n * 获取变化限制配置\n * @param path - 变量路径\n * @returns 对应的变化限制配置\n */\nexport function getChangeLimitForPath(path: string): ChangeLimitConfig | null {\n  // 直接匹配\n  if (CHANGE_LIMITS[path]) {\n    return CHANGE_LIMITS[path];\n  }\n\n  // 模式匹配\n  if (path.includes('次要角色') && path.endsWith('.信任值')) {\n    return CHANGE_LIMITS.pattern_信任值;\n  }\n\n  if (path.includes('特殊角色')) {\n    if (path.endsWith('.好感度')) {\n      return CHANGE_LIMITS.pattern_好感度;\n    } else if (path.endsWith('.依赖度')) {\n      return CHANGE_LIMITS.pattern_依赖度;\n    } else if (path.endsWith('.认可度')) {\n      return CHANGE_LIMITS.pattern_认可度;\n    } else if (path.endsWith('.污秽侵蚀度')) {\n      return CHANGE_LIMITS.pattern_污秽侵蚀度;\n    } else if (path.endsWith('.模因侵蚀率')) {\n      return CHANGE_LIMITS.pattern_模因侵蚀率;\n    }\n  }\n\n  return null;\n}\n\n/**\n * 应用变化幅度限制\n * @param newValue - 新值\n * @param oldValue - 旧值\n * @param changeLimit - 变化限制配置\n * @param path - 变量路径（用于日志）\n * @returns 限制后的值\n */\nexport function applyChangeLimit(\n  newValue: number,\n  oldValue: number,\n  changeLimit: ChangeLimitConfig,\n  path: string,\n): number {\n  const actualChange = newValue - oldValue;\n\n  // 特殊处理：正向无限制变化（澪的治愈进度）\n  if (changeLimit.maxChange === Number.POSITIVE_INFINITY) {\n    if (actualChange < 0 && actualChange < changeLimit.minChange) {\n      const limitedValue = oldValue + changeLimit.minChange;\n      console.log(`变化幅度限制: ${path} 负向变化 ${actualChange.toFixed(5)} 限制为 ${changeLimit.minChange}`);\n      return limitedValue;\n    }\n    return newValue; // 正向变化无限制\n  }\n\n  // 标准双向变化限制\n  if (actualChange > changeLimit.maxChange) {\n    const limitedValue = oldValue + changeLimit.maxChange;\n    console.log(`变化幅度限制: ${path} 正向变化 ${actualChange.toFixed(5)} 限制为 ${changeLimit.maxChange}`);\n    return limitedValue;\n  }\n\n  if (actualChange < changeLimit.minChange) {\n    const limitedValue = oldValue + changeLimit.minChange;\n    console.log(`变化幅度限制: ${path} 负向变化 ${actualChange.toFixed(5)} 限制为 ${changeLimit.minChange}`);\n    return limitedValue;\n  }\n\n  return newValue; // 在允许范围内\n}\n\n/**\n * 应用变化幅度限制到数值\n * @param value - 当前值\n * @param path - 变量路径\n * @param oldValue - 旧值\n * @returns 应用变化幅度限制后的值\n */\nexport function applyChangeLimitToValue(value: any, path: string, oldValue: any): any {\n  // 只处理数值类型\n  if (typeof value !== 'number' || typeof oldValue !== 'number') {\n    return value;\n  }\n\n  const changeLimit = getChangeLimitForPath(path);\n  if (!changeLimit) {\n    return value;\n  }\n\n  const limitedValue = applyChangeLimit(value, oldValue, changeLimit, path);\n\n  return limitedValue;\n}\n","// 注入提示词的ID，用于管理和移除\r\nconst WORLDBOOK_SCAN_PROMPT_ID = 'var-change-worldbook-scan';\r\n\r\n/**\r\n * 处理世界书扫描文本设置\r\n * @param stat_data - stat_data对象\r\n */\r\nexport function updateWorldbookScanText(stat_data: Record<string, any>): void {\r\n  const scanTexts: string[] = [];\r\n\r\n  // 添加当前位置作为扫描文本\r\n  const currentLocation = _.get(stat_data, '全局信息.当前位置', '');\r\n  if (currentLocation && typeof currentLocation === 'string') {\r\n    scanTexts.push(currentLocation.trim());\r\n  }\r\n\r\n  // 添加所有次要角色名称作为扫描文本\r\n  const secondaryCharacters = _.get(stat_data, '次要角色', {});\r\n  if (_.isObject(secondaryCharacters) && !Array.isArray(secondaryCharacters)) {\r\n    for (const characterName of Object.keys(secondaryCharacters)) {\r\n      if (characterName && typeof characterName === 'string') {\r\n        // 添加角色名\r\n        scanTexts.push(characterName.trim());\r\n      }\r\n    }\r\n  }\r\n\r\n  // 去重并过滤空文本\r\n  const uniqueScanTexts = [...new Set(scanTexts)].filter(text => text.length > 0);\r\n\r\n  if (uniqueScanTexts.length > 0) {\r\n    // 先移除之前的注入提示词\r\n    uninjectPrompts([WORLDBOOK_SCAN_PROMPT_ID]);\r\n\r\n    // 创建扫描文本内容\r\n    const scanTextString = uniqueScanTexts.join(', ');\r\n\r\n    // 使用 injectPrompts 注入世界书扫描文本\r\n    try {\r\n      injectPrompts([\r\n        {\r\n          id: WORLDBOOK_SCAN_PROMPT_ID,\r\n          position: 'none', // 不发给AI，只用来激活世界书\r\n          depth: 0,\r\n          role: 'user',\r\n          content: scanTextString,\r\n          should_scan: true, // 作为欲扫描文本，加入世界书扫描\r\n        },\r\n      ]);\r\n\r\n      console.log(`[世界书扫描] 注入扫描文本: ${scanTextString}`);\r\n    } catch (error) {\r\n      console.warn(`[世界书扫描] 注入扫描文本失败:`, error instanceof Error ? error.message : String(error));\r\n    }\r\n  } else {\r\n    // 如果没有扫描文本，移除之前的注入\r\n    uninjectPrompts([WORLDBOOK_SCAN_PROMPT_ID]);\r\n  }\r\n}\r\n","import { INTERNAL_KEYS } from './config/constants';\nimport { detectSecondaryCharacterChanges } from './handlers/character-handler';\nimport { handlePlotProgress } from './handlers/plot-handler';\nimport { handleMioStabilizer } from './handlers/special-handler';\nimport { applyChangeLimitToValue } from './handlers/validation-handler';\nimport { updateWorldbookScanText } from './handlers/worldbook-handler';\nimport type { PendingValidation } from './types';\n\n// 存储需要延迟处理的变化幅度限制\nconst PENDING_CHANGE_LIMITS: PendingValidation[] = [];\n\n/**\n * 处理MVU变量更新开始事件\n * @param variables - 包含stat_data的变量记录\n * @param out_is_updated - 指示是否已有更新的标志\n */\nfunction variableUpdateStarted(variables: Record<string, any>): void {\n  console.log('Variable update started');\n\n  // 存储当前次要角色状态用于后续比较（存储在stat_data中确保持久性）\n  if (variables?.stat_data) {\n    const currentSecondaryCharacters = _.get(variables.stat_data, '次要角色');\n    _.set(\n      variables.stat_data,\n      INTERNAL_KEYS.PREVIOUS_SECONDARY_CHARACTERS_KEY,\n      _.cloneDeep(currentSecondaryCharacters),\n    );\n  }\n}\n\n/**\n * 处理MVU变量更新事件\n * @param stat_data - 包含更新变量的数据结构\n * @param path - 标识被更新变量的路径或键\n * @param oldValue - 变量更新前的值\n * @param newValue - 变量更新后的值\n */\nfunction variableUpdated(stat_data: Record<string, any>, path: string, oldValue: any, newValue: any): void {\n  console.log(`Variable updated: ${path} from ${oldValue} to ${newValue}`);\n\n  // 记录需要应用变化幅度限制的更新\n  PENDING_CHANGE_LIMITS.push({\n    stat_data,\n    path,\n    oldValue,\n    newValue,\n  });\n\n  // 调用各个专门的处理函数\n  handlePlotProgress(stat_data, path, oldValue, newValue);\n  handleMioStabilizer(stat_data, path, newValue);\n}\n\n/**\n * 处理MVU变量更新结束事件\n * @param variables - 包含状态和显示相关数据的对象\n * @param out_is_updated - 指示变量在处理过程中是否被更新的标志\n */\nfunction variableUpdateEnded(variables: Record<string, any>): void {\n  console.log('Variable update ended');\n\n  // 应用变化幅度限制（在 Zod 验证后执行）\n  if (PENDING_CHANGE_LIMITS.length > 0) {\n    console.log(`[变化幅度限制] 处理 ${PENDING_CHANGE_LIMITS.length} 个待限制的变量更新`);\n\n    for (const validation of PENDING_CHANGE_LIMITS) {\n      const { stat_data, path, oldValue, newValue } = validation;\n\n      // 获取当前实际值\n      const currentValue = _.get(stat_data, path);\n\n      // 应用变化幅度限制\n      const limitedValue = applyChangeLimitToValue(currentValue, path, oldValue);\n\n      if (limitedValue !== currentValue) {\n        _.set(stat_data, path, limitedValue);\n        console.log(`[变化幅度限制] 已应用限制: ${path} = ${limitedValue}`);\n      }\n    }\n\n    // 清空待处理列表\n    PENDING_CHANGE_LIMITS.length = 0;\n  }\n\n  if (variables?.stat_data) {\n    // 检测次要角色变化\n    const currentSecondaryCharacters = _.get(variables.stat_data, '次要角色');\n    const previousSecondaryCharacters = _.get(variables.stat_data, INTERNAL_KEYS.PREVIOUS_SECONDARY_CHARACTERS_KEY);\n\n    if (previousSecondaryCharacters && currentSecondaryCharacters) {\n      detectSecondaryCharacterChanges(variables.stat_data, previousSecondaryCharacters, currentSecondaryCharacters);\n    }\n\n    // 更新存储的状态（存储在stat_data中确保持久性）\n    _.set(\n      variables.stat_data,\n      INTERNAL_KEYS.PREVIOUS_SECONDARY_CHARACTERS_KEY,\n      _.cloneDeep(currentSecondaryCharacters),\n    );\n\n    // 更新世界书扫描文本\n    updateWorldbookScanText(variables.stat_data);\n  }\n}\n\n// 注册MVU事件监听器\n$(() => {\n  eventOn('mag_variable_update_started', variableUpdateStarted);\n  eventOn('mag_variable_updated', variableUpdated);\n  eventOn('mag_variable_update_ended', variableUpdateEnded);\n\n  console.log('MVU变量处理脚本已加载');\n});\n","/**\n * 处理剧情进度变更\n * @param stat_data - stat_data对象\n * @param path - 变量路径\n * @param oldValue - 旧值\n * @param newValue - 新值\n */\nexport function handlePlotProgress(stat_data: Record<string, any>, path: string, oldValue: any, newValue: any): void {\n  if (path === 'plot_record.剧情进度') {\n    console.log(`剧情进度从 \"${oldValue}\" 变更为 \"${newValue}\"`);\n\n    // 清空剧情节点记录\n    if (_.has(stat_data, 'plot_record.剧情节点记录')) {\n      _.set(stat_data, 'plot_record.剧情节点记录', []);\n      console.log('已清空剧情节点记录');\n    }\n  }\n}\n","/**\n * 处理澪的星尘稳定剂注入相关逻辑\n * @param stat_data - stat_data对象\n * @param path - 变量路径\n * @param newValue - 新值\n */\nexport function handleMioStabilizer(stat_data: Record<string, any>, path: string, newValue: any): void {\n  // 检查澪是否注入星尘稳定剂\n  if (path === '主要角色.澪.注入星尘稳定剂' && newValue === true) {\n    console.log(`澪.注入星尘稳定剂 的值变为 true，设置治愈进度为 90`);\n\n    // 将治愈进度设置为 90（这是直接设置，不受变化幅度限制）\n    if (_.has(stat_data, '主要角色.澪.治愈进度')) {\n      _.set(stat_data, '主要角色.澪.治愈进度', 90);\n      console.log('澪的治愈进度已设置为 90');\n    }\n  }\n\n  // 防止治愈进度在已注入星尘稳定剂的情况下被修改\n  if (path === '主要角色.澪.治愈进度' && _.get(stat_data, '主要角色.澪.注入星尘稳定剂') === true) {\n    console.log(`澪已注入星尘稳定剂，治愈进度不得修改，恢复为 90`);\n    _.set(stat_data, '主要角色.澪.治愈进度', 90);\n  }\n}\n"],"names":["INTERNAL_KEYS","getStandardizedRecordName","characterName","trim","split","getCurrentTimeAndLocation","stat_data","globalInfo","_","get","handleSecondaryCharacterEntry","has","set","currentInfo","standardizedName","recordPath","characterPath","characterRecord","console","log","savedTrustValue","savedItems","currentItems","Object","keys","length","mergedItems","newRecord","handleSecondaryCharacterExit","characterData","defaultRecord","currentTrust","CHANGE_LIMITS","minChange","maxChange","Number","POSITIVE_INFINITY","applyChangeLimitToValue","value","path","oldValue","changeLimit","includes","endsWith","getChangeLimitForPath","limitedValue","newValue","actualChange","toFixed","applyChangeLimit","WORLDBOOK_SCAN_PROMPT_ID","PENDING_CHANGE_LIMITS","variableUpdateStarted","variables","currentSecondaryCharacters","cloneDeep","variableUpdated","push","handlePlotProgress","handleMioStabilizer","variableUpdateEnded","validation","currentValue","previousSecondaryCharacters","oldSecondaryCharacters","newSecondaryCharacters","oldCharNames","newCharNames","addedCharacters","filter","name","removedCharacters","detectSecondaryCharacterChanges","scanTexts","currentLocation","secondaryCharacters","isObject","Array","isArray","uniqueScanTexts","Set","text","uninjectPrompts","scanTextString","join","injectPrompts","id","position","depth","role","content","should_scan","error","warn","Error","message","String","updateWorldbookScanText","$","eventOn"],"ignoreList":[],"sourceRoot":""}